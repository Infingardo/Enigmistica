<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anagrammi e Ricerca Parole</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 0.9em; }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #3498db;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .tab:hover { background: #ebf5fb; }
        .tab.active { background: #3498db; color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .status-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .status { font-size: 0.9em; }
        .status.loaded { color: #27ae60; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button:active:not(:disabled) { transform: scale(0.98); }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover:not(:disabled) { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover:not(:disabled) { background: #1e8449; }
        .btn-secondary { background: #ecf0f1; color: #333; }
        .btn-secondary:hover:not(:disabled) { background: #bdc3c7; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover:not(:disabled) { background: #d68910; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover:not(:disabled) { background: #c0392b; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        
        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        
        input[type="text"]:focus { outline: none; border-color: #3498db; }
        
        .options { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .option { display: flex; align-items: center; gap: 6px; }
        .option label { font-size: 0.9em; color: #555; }
        
        select { padding: 6px 10px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 0.9em; }
        
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .results-header h3 { margin: 0; color: #2c3e50; }
        .results-count { color: #7f8c8d; font-size: 0.9em; }
        .results-container { max-height: 500px; overflow-y: auto; }
        .results-section { margin-bottom: 20px; }
        
        .results-section h4 {
            color: #3498db;
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.95em;
        }
        
        .results-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .result-word {
            background: #ecf0f1;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .result-word:hover { background: #3498db; color: white; }
        .result-multi { background: #e8f6f3; border-left: 3px solid #1abc9c; }
        .result-multi:hover { background: #1abc9c; }
        .result-partial { background: #fdf2e9; border-left: 3px solid #e67e22; }
        .result-partial:hover { background: #e67e22; }
        .result-custom { background: #e8f8f5; border: 1px dashed #1abc9c; }
        .result-custom:hover { background: #1abc9c; }
        
        .no-results { text-align: center; color: #7f8c8d; padding: 30px; }
        .no-results-small { color: #95a5a6; font-style: italic; padding: 8px 0; }
        .loading-box { text-align: center; padding: 20px; }
        
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #ecf0f1;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .progress-bar { width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: #3498db; transition: width 0.3s; }
        
        .info-message { padding: 12px 15px; border-radius: 8px; margin-top: 15px; font-size: 0.9em; }
        .info-message.error { background: #fdedec; border-left: 4px solid #e74c3c; }
        .info-message.success { background: #e8f6f3; border-left: 4px solid #27ae60; }
        
        .hidden { display: none !important; }
        
        .dict-options { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ecf0f1; }
        .dict-options summary { cursor: pointer; color: #7f8c8d; font-size: 0.9em; }
        .dict-options-content { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
        .custom-words-count { font-size: 0.85em; color: #7f8c8d; margin-top: 10px; }
        
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            z-index: 1000;
            min-width: 150px;
        }
        
        .context-menu-item { padding: 10px 16px; cursor: pointer; font-size: 0.9em; }
        .context-menu-item:hover { background: #f5f5f5; }
        .context-menu-item.danger { color: #e74c3c; }
        
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal { background: white; border-radius: 12px; padding: 25px; max-width: 400px; width: 100%; }
        .modal h3 { margin: 0 0 20px 0; color: #2c3e50; }
        .modal input { margin-bottom: 10px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
        
        .length-group { margin-bottom: 8px; }
        .length-label { font-size: 0.8em; color: #7f8c8d; margin-bottom: 4px; }
        .hint { font-size: 0.8em; color: #95a5a6; text-align: center; margin-top: 10px; }
        
        .hint-box {
            background: #fef9e7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.85em;
        }
        
        .hint-box code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .dict-selector { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        
        .dict-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dict-btn:hover { border-color: #3498db; }
        .dict-btn.active { border-color: #3498db; background: #ebf5fb; }
        .dict-btn-title { font-weight: bold; color: #2c3e50; }
        .dict-btn-info { font-size: 0.8em; color: #7f8c8d; margin-top: 4px; }
        
        .credits { font-size: 0.75em; color: #95a5a6; text-align: center; margin-top: 5px; }
        .credits a { color: #7f8c8d; }
        
        /* Quiz styles */
        .quiz-word {
            text-align: center;
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 0.1em;
            margin: 20px 0;
            text-transform: uppercase;
        }
        
        .quiz-prompt {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .quiz-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .quiz-stat {
            text-align: center;
        }
        
        .quiz-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
        }
        
        .quiz-stat-value.warning {
            color: #e74c3c;
            animation: pulse 0.5s ease infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .quiz-stat-label {
            font-size: 0.8em;
            color: #7f8c8d;
        }
        
        .quiz-found {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
            min-height: 40px;
        }
        
        .quiz-found-word {
            background: #27ae60;
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.95em;
            animation: pop 0.3s ease;
        }
        
        .quiz-found-word.missed {
            background: #e74c3c;
            opacity: 0.7;
        }
        
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .quiz-feedback {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
            min-height: 44px;
        }
        
        .quiz-feedback.correct { background: #e8f6f3; color: #27ae60; }
        .quiz-feedback.wrong { background: #fdedec; color: #e74c3c; }
        .quiz-feedback.duplicate { background: #fef9e7; color: #f39c12; }
        .quiz-feedback.empty { background: transparent; }
        
        .quiz-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .quiz-progress {
            background: #ecf0f1;
            border-radius: 20px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .quiz-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }
        
        @media (max-width: 600px) {
            body { padding: 10px; }
            .card { padding: 15px; }
            .options { flex-direction: column; gap: 10px; }
            .status-bar { flex-direction: column; align-items: stretch; }
            .btn-group { flex-direction: column; }
            button { width: 100%; }
            .modal-buttons { flex-direction: column; }
            .tab { padding: 10px 8px; font-size: 0.85em; }
            .quiz-word { font-size: 1.8em; }
            .quiz-buttons { flex-direction: column; }
            .quiz-buttons button { width: 100%; }
            .cambi-inputs { flex-direction: column; }
            .cambi-arrow { transform: rotate(90deg); }
            .game-selector { flex-direction: column; }
        }
        
        /* Games tab styles */
        .game-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .game-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .game-btn:hover { border-color: #9b59b6; background: #f5eef8; }
        .game-btn.active { border-color: #9b59b6; background: #9b59b6; color: white; }
        
        .game-content { display: none; }
        .game-content.active { display: block; }
        
        .cambi-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .cambi-input {
            flex: 1;
            text-transform: uppercase;
        }
        
        .cambi-arrow {
            font-size: 1.5em;
            color: #9b59b6;
            font-weight: bold;
        }
        
        .cambi-chain {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            justify-content: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .cambi-step {
            background: #9b59b6;
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .cambi-step.start { background: #27ae60; }
        .cambi-step.end { background: #e74c3c; }
        
        .cambi-step-arrow {
            color: #9b59b6;
            font-weight: bold;
        }
        
        .bifronte-pair {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #f5eef8;
            padding: 8px 14px;
            border-radius: 20px;
            margin: 4px;
        }
        
        .bifronte-arrow {
            color: #9b59b6;
        }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: center; align-items: center; gap: 15px;">
        <h1 style="margin: 0;">üî§ Enigmistica</h1>
        <button onclick="showHelp()" style="background: #3498db; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.1em; cursor: pointer; font-weight: bold;">?</button>
    </div>
    <p class="subtitle">Anagrammi e ricerca parole italiane</p>
    
    <div class="card">
        <div class="status-bar">
            <div class="status" id="dictStatus">
                <span id="statusText">‚è≥ Seleziona un vocabolario...</span>
            </div>
            <div class="btn-group">
                <button class="btn-success btn-small" onclick="showAddWordModal()" id="btnAddWord" disabled>‚ûï Aggiungi</button>
            </div>
        </div>
        
        <div class="dict-selector" id="dictSelector">
            <button class="dict-btn" onclick="loadDict('ridotto')">
                <div class="dict-btn-title">üìò Ridotto</div>
                <div class="dict-btn-info">~31k parole ‚Ä¢ Veloce</div>
            </button>
            <button class="dict-btn" onclick="loadDict('completo')">
                <div class="dict-btn-title">üìö Completo</div>
                <div class="dict-btn-info">~283k parole ‚Ä¢ Esaustivo</div>
            </button>
        </div>
        
        <div id="loadingIndicator" class="loading-box hidden">
            <div class="spinner"></div>
            <div id="loadingText">Caricamento...</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
        </div>
        
        <div id="infoMessage" class="info-message hidden"></div>
        
        <details class="dict-options hidden" id="dictOptions">
            <summary>Opzioni dizionario</summary>
            <div class="dict-options-content">
                <button class="btn-secondary btn-small" onclick="exportDictionary()">üì• Esporta</button>
                <button class="btn-warning btn-small" onclick="suggestWord()">‚úâÔ∏è Suggerisci</button>
                <button class="btn-secondary btn-small" onclick="restoreRemoved()">‚ôªÔ∏è Ripristina</button>
                <button class="btn-danger btn-small" onclick="switchDict()">üîÑ Cambia</button>
            </div>
            <div class="custom-words-count" id="customWordsCount"></div>
        </details>
        
        <p class="credits">Vocabolario: <a href="http://www.enignet.it" target="_blank">Enilab/BEI</a></p>
    </div>
    
    <div class="card" id="searchCard">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('anagrammi')">üîÑ Anagrammi</button>
            <button class="tab" onclick="switchTab('ricerca')">üîç Cerca</button>
            <button class="tab" onclick="switchTab('quiz')">üéØ Quiz</button>
            <button class="tab" onclick="switchTab('giochi')">üéÆ Giochi</button>
        </div>
        
        <!-- Tab Anagrammi -->
        <div class="tab-content active" id="tab-anagrammi">
            <input type="text" id="inputWord" placeholder="Scrivi una parola..." onkeyup="handleKeyUp(event, 'anagrammi')" disabled>
            
            <div class="options">
                <div class="option"><input type="checkbox" id="chkMulti" checked><label for="chkMulti">Multi-parola</label></div>
                <div class="option"><input type="checkbox" id="chkPartial" checked><label for="chkPartial">Parole incluse</label></div>
                <div class="option"><label for="selMaxWords">Max:</label><select id="selMaxWords"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option></select></div>
                <div class="option"><label for="selMinLen">Min:</label><select id="selMinLen"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select></div>
            </div>
            
            <button class="btn-primary" onclick="findAnagrams()" id="btnSearch" disabled style="width: 100%;">üîç Cerca anagrammi</button>
            <p class="hint">üí° Tieni premuto su una parola per rimuoverla</p>
        </div>
        
        <!-- Tab Ricerca -->
        <div class="tab-content" id="tab-ricerca">
            <div class="hint-box">
                <strong>Pattern:</strong> 
                <code>.</code> o <code>?</code> = una lettera &nbsp;
                <code>+</code> = vocale &nbsp;
                <code>-</code> = consonante &nbsp;
                <code>*</code> = pi√π lettere
            </div>
            
            <input type="text" id="inputPattern" placeholder="Es: cas+, *zione, p-+ma..." onkeyup="handleKeyUp(event, 'ricerca')" disabled>
            
            <div class="options">
                <div class="option">
                    <label for="selMinLenSearch">Lunghezza min:</label>
                    <select id="selMinLenSearch">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="option">
                    <label for="selMaxLenSearch">max:</label>
                    <select id="selMaxLenSearch">
                        <option value="10">10</option>
                        <option value="15" selected>15</option>
                        <option value="20">20</option>
                        <option value="99">‚àû</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-primary" onclick="searchPattern()" id="btnPattern" disabled style="width: 100%;">üîç Cerca parole</button>
            <p class="hint">Es: <code>cas+</code> ‚Üí casa, case, caso | <code>*mente</code> ‚Üí parole che finiscono in "mente"</p>
        </div>
        
        <!-- Tab Quiz -->
        <div class="tab-content" id="tab-quiz">
            <div id="quizStart">
                <div class="hint-box">
                    <strong>üéØ Quiz Anagrammi</strong><br>
                    Ti mostro una parola, tu trovi tutti i suoi anagrammi!<br>
                    <span style="font-size: 0.9em; color: #7f8c8d;">Scrivi un anagramma alla volta e premi Invio. Per multi-parola: "parola1 parola2" o "parola1 + parola2"</span>
                </div>
                
                <div class="options">
                    <div class="option">
                        <label for="selQuizMinLen">Lunghezza min:</label>
                        <select id="selQuizMinLen">
                            <option value="4">4</option>
                            <option value="5" selected>5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                        </select>
                    </div>
                    <div class="option">
                        <label for="selQuizMaxLen">max:</label>
                        <select id="selQuizMaxLen">
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8" selected>8</option>
                            <option value="10">10</option>
                            <option value="12">12</option>
                            <option value="14">14</option>
                        </select>
                    </div>
                    <div class="option">
                        <label for="selQuizMinAnagrams">Min anagrammi:</label>
                        <select id="selQuizMinAnagrams">
                            <option value="1">1</option>
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn-success" onclick="startQuiz()" id="btnStartQuiz" disabled style="width: 100%;">üéØ Inizia Quiz</button>
            </div>
            
            <div id="quizGame" class="hidden">
                <div class="quiz-stats">
                    <div class="quiz-stat">
                        <div class="quiz-stat-value" id="quizTimer">60</div>
                        <div class="quiz-stat-label">Secondi</div>
                    </div>
                    <div class="quiz-stat">
                        <div class="quiz-stat-value" id="quizStreak">0</div>
                        <div class="quiz-stat-label">Serie</div>
                    </div>
                    <div class="quiz-stat">
                        <div class="quiz-stat-value" id="quizScore">0</div>
                        <div class="quiz-stat-label">Punti</div>
                    </div>
                </div>
                
                <div class="quiz-word" id="quizWord">PAROLA</div>
                <div class="quiz-prompt" id="quizPrompt">Trova X anagrammi</div>
                
                <div class="quiz-progress">
                    <div class="quiz-progress-fill" id="quizProgressFill" style="width: 0%"></div>
                </div>
                
                <div class="quiz-found" id="quizFound"></div>
                
                <div class="quiz-feedback empty" id="quizFeedback">&nbsp;</div>
                
                <input type="text" id="quizInput" placeholder="Scrivi un anagramma..." onkeyup="handleQuizKeyUp(event)" disabled>
                
                <div class="quiz-buttons">
                    <button class="btn-warning" onclick="skipQuizWord()">‚è≠Ô∏è Passo</button>
                    <button class="btn-secondary" onclick="endQuiz()">üõë Termina</button>
                </div>
            </div>
        </div>
        
        <!-- Tab Giochi -->
        <div class="tab-content" id="tab-giochi">
            <div class="game-selector">
                <button class="game-btn active" onclick="selectGame('cambi')">üîÄ Cambi</button>
                <button class="game-btn" onclick="selectGame('palindromi')">ü™û Palindromi</button>
                <button class="game-btn" onclick="selectGame('bifronti')">‚ÜîÔ∏è Bifronti</button>
            </div>
            <div class="game-selector" style="margin-top: -12px;">
                <button class="game-btn" onclick="selectGame('scarti')">‚úÇÔ∏è Scarti</button>
                <button class="game-btn" onclick="selectGame('zeppe')">üîß Zeppe</button>
                <button class="game-btn" onclick="selectGame('aggiunte')">‚ûï Aggiunte</button>
                <button class="game-btn" onclick="selectGame('sciarade')">üß© Sciarade</button>
            </div>
            
            <!-- Cambi -->
            <div class="game-content active" id="game-cambi">
                <div class="hint-box">
                    <strong>üîÄ Cambi</strong><br>
                    Trasforma una parola in un'altra cambiando una lettera alla volta.<br>
                    Ogni passaggio deve essere una parola valida.
                </div>
                
                <div class="cambi-inputs">
                    <input type="text" id="cambiStart" placeholder="Parola iniziale..." class="cambi-input" onkeyup="if(event.key==='Enter')findCambi()">
                    <span class="cambi-arrow">‚Üí</span>
                    <input type="text" id="cambiEnd" placeholder="Parola finale..." class="cambi-input" onkeyup="if(event.key==='Enter')findCambi()">
                </div>
                
                <button class="btn-primary" onclick="findCambi()" id="btnCambi" disabled style="width: 100%;">üîÄ Trova catena</button>
                <p class="hint">Es: CANTO ‚Üí CENTO ‚Üí CINTO</p>
            </div>
            
            <!-- Palindromi -->
            <div class="game-content" id="game-palindromi">
                <div class="hint-box">
                    <strong>ü™û Palindromi</strong><br>
                    Parole che si leggono uguali in entrambi i sensi.
                </div>
                
                <div class="options">
                    <div class="option">
                        <label for="selPalMinLen">Lunghezza min:</label>
                        <select id="selPalMinLen">
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="option">
                        <label for="selPalMaxLen">max:</label>
                        <select id="selPalMaxLen">
                            <option value="8">8</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                            <option value="99">‚àû</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn-primary" onclick="findPalindromi()" id="btnPalindromi" disabled style="width: 100%;">ü™û Trova palindromi</button>
                <p class="hint">Es: ANNA, OTTO, RADAR, OSSESSO</p>
            </div>
            
            <!-- Bifronti -->
            <div class="game-content" id="game-bifronti">
                <div class="hint-box">
                    <strong>‚ÜîÔ∏è Bifronti</strong><br>
                    Parole che lette al contrario formano un'altra parola.
                </div>
                
                <div class="options">
                    <div class="option">
                        <label for="selBifMinLen">Lunghezza min:</label>
                        <select id="selBifMinLen">
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="option">
                        <label for="selBifMaxLen">max:</label>
                        <select id="selBifMaxLen">
                            <option value="8">8</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                            <option value="99">‚àû</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn-primary" onclick="findBifronti()" id="btnBifronti" disabled style="width: 100%;">‚ÜîÔ∏è Trova bifronti</button>
                <p class="hint">Es: ENOTECA ‚Üî ACETONE, AMOR ‚Üî ROMA</p>
            </div>
            
            <!-- Scarti -->
            <div class="game-content" id="game-scarti">
                <div class="hint-box">
                    <strong>‚úÇÔ∏è Scarti</strong><br>
                    Togli una lettera da una parola per formarne un'altra.
                </div>
                
                <input type="text" id="scartiInput" placeholder="Parola da scartare..." onkeyup="if(event.key==='Enter')findScarti()">
                
                <button class="btn-primary" onclick="findScarti()" id="btnScarti" disabled style="width: 100%;">‚úÇÔ∏è Trova scarti</button>
                <p class="hint">Es: CAMINO ‚Üí CAINO, CAMPO ‚Üí CAPO</p>
            </div>
            
            <!-- Zeppe -->
            <div class="game-content" id="game-zeppe">
                <div class="hint-box">
                    <strong>üîß Zeppe</strong><br>
                    Aggiungi una lettera dentro una parola per formarne un'altra.
                </div>
                
                <input type="text" id="zeppeInput" placeholder="Parola da zeppare..." onkeyup="if(event.key==='Enter')findZeppe()">
                
                <button class="btn-primary" onclick="findZeppe()" id="btnZeppe" disabled style="width: 100%;">üîß Trova zeppe</button>
                <p class="hint">Es: CANTO ‚Üí CANTO, PANE ‚Üí PLANE</p>
            </div>
            
            <!-- Aggiunte -->
            <div class="game-content" id="game-aggiunte">
                <div class="hint-box">
                    <strong>‚ûï Aggiunte</strong><br>
                    Aggiungi una lettera all'inizio o alla fine di una parola.
                </div>
                
                <input type="text" id="aggiunteInput" placeholder="Parola base..." onkeyup="if(event.key==='Enter')findAggiunte()">
                
                <div class="options">
                    <div class="option">
                        <input type="checkbox" id="chkAggiuntaInizio" checked>
                        <label for="chkAggiuntaInizio">Inizio (carpa ‚Üí scarpa)</label>
                    </div>
                    <div class="option">
                        <input type="checkbox" id="chkAggiuntaFine" checked>
                        <label for="chkAggiuntaFine">Fine (che ‚Üí chef)</label>
                    </div>
                </div>
                
                <button class="btn-primary" onclick="findAggiunte()" id="btnAggiunte" disabled style="width: 100%;">‚ûï Trova aggiunte</button>
                <p class="hint">Es: OCA ‚Üí FOCA, ROCA, TOCA... | ART ‚Üí ARTE, ARTI</p>
            </div>
            
            <!-- Sciarade -->
            <div class="game-content" id="game-sciarade">
                <div class="hint-box">
                    <strong>üß© Sciarade</strong><br>
                    Trova parole che si scompongono in due o pi√π parole di senso compiuto.
                </div>
                
                <input type="text" id="sciaradeInput" placeholder="Parola da scomporre..." onkeyup="if(event.key==='Enter')findSciarade()">
                
                <div class="options">
                    <div class="option">
                        <label for="selSciaradeMinPart">Lungh. min parte:</label>
                        <select id="selSciaradeMinPart">
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="option">
                        <label for="selSciaradeMaxParts">Max parti:</label>
                        <select id="selSciaradeMaxParts">
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn-primary" onclick="findSciarade()" id="btnSciarade" disabled style="width: 100%;">üß© Scomponi</button>
                <button class="btn-secondary" onclick="findSciaradeInverse()" id="btnSciaradeInv" disabled style="width: 100%; margin-top: 8px;">üîç Cerca sciarade nel dizionario</button>
                <p class="hint">Es: CANICOLA = CANI + COLA, DIMISSIONARIO = DI + MISSIONARIO</p>
            </div>
        </div>
    </div>
    
    <div class="card hidden" id="resultsCard">
        <div class="results-header"><h3>Risultati</h3><span class="results-count" id="resultsCount"></span></div>
        <div class="results-container" id="resultsContainer"></div>
    </div>
    
    <div class="context-menu hidden" id="contextMenu">
        <div class="context-menu-item" onclick="searchSelectedWord()">üîÑ Anagrammi</div>
        <div class="context-menu-item" onclick="patternSelectedWord()">üîç Cerca pattern</div>
        <div class="context-menu-item danger" onclick="removeSelectedWord()">üóëÔ∏è Rimuovi</div>
    </div>
    
    <div class="modal-overlay hidden" id="addWordModal" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <h3>‚ûï Aggiungi parola</h3>
            <input type="text" id="newWordInput" placeholder="Nuova parola..." onkeyup="handleAddWordKeyUp(event)">
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0;">Salvata nel browser.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeAddWordModal()">Annulla</button>
                <button class="btn-success" onclick="addWord()">Aggiungi</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="suggestModal" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <h3>‚úâÔ∏è Suggerisci parola</h3>
            <input type="text" id="suggestWordInput" placeholder="Parola da suggerire...">
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0;">Si aprir√† il client email.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeSuggestModal()">Annulla</button>
                <button class="btn-warning" onclick="sendSuggestion()">Invia</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay hidden" id="helpModal" onclick="closeModalOnOverlay(event)">
        <div class="modal" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3>üìñ Guida all'uso</h3>
            
            <div style="text-align: left; font-size: 0.9em; line-height: 1.6;">
                <h4 style="color: #3498db; margin: 15px 0 8px;">üöÄ Per iniziare</h4>
                <p>Scegli un vocabolario: <strong>Ridotto</strong> (~31k parole, veloce) o <strong>Completo</strong> (~283k parole, esaustivo). Il dizionario viene salvato nel browser per gli usi successivi.</p>
                
                <h4 style="color: #3498db; margin: 15px 0 8px;">üîÑ Anagrammi</h4>
                <p>Scrivi una parola e trova tutti i suoi anagrammi.</p>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li><strong>Multi-parola:</strong> trova anagrammi composti da pi√π parole (es. ASTRONAVE ‚Üí RASATO + VEN)</li>
                    <li><strong>Parole incluse:</strong> mostra anche parole pi√π corte contenute nelle lettere</li>
                </ul>
                
                <h4 style="color: #3498db; margin: 15px 0 8px;">üîç Cerca (Pattern)</h4>
                <p>Cerca parole usando caratteri speciali:</p>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li><code>.</code> o <code>?</code> = una lettera qualsiasi</li>
                    <li><code>+</code> = una vocale</li>
                    <li><code>-</code> = una consonante</li>
                    <li><code>*</code> = zero o pi√π lettere</li>
                </ul>
                <p>Esempi: <code>cas+</code> ‚Üí casa, case, caso | <code>*mente</code> ‚Üí parole che finiscono in -mente</p>
                
                <h4 style="color: #3498db; margin: 15px 0 8px;">üéØ Quiz</h4>
                <p>Mettiti alla prova! Ti viene mostrata una parola e devi trovare tutti i suoi anagrammi.</p>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li>Scrivi <strong>un anagramma alla volta</strong> e premi Invio</li>
                    <li>Per multi-parola: scrivi "parola1 parola2" o "parola1 + parola2"</li>
                    <li>Hai 60 secondi per parola</li>
                    <li><strong>Serie:</strong> parole completate consecutive senza saltare</li>
                </ul>
                
                <h4 style="color: #3498db; margin: 15px 0 8px;">üéÆ Giochi</h4>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li><strong>üîÄ Cambi:</strong> trasforma una parola in un'altra cambiando una lettera alla volta</li>
                    <li><strong>ü™û Palindromi:</strong> parole uguali lette al contrario (ANNA, RADAR)</li>
                    <li><strong>‚ÜîÔ∏è Bifronti:</strong> parole che al contrario ne formano un'altra (AMOR ‚Üî ROMA)</li>
                    <li><strong>‚úÇÔ∏è Scarti:</strong> togli una lettera (CAMPO ‚Üí CAPO)</li>
                    <li><strong>üîß Zeppe:</strong> aggiungi una lettera dentro (CANTO ‚Üí CANTO)</li>
                    <li><strong>‚ûï Aggiunte:</strong> aggiungi una lettera all'inizio o fine</li>
                    <li><strong>üß© Sciarade:</strong> scomponi in parole (CANICOLA = CANI + COLA)</li>
                </ul>
                
                <h4 style="color: #3498db; margin: 15px 0 8px;">üí° Suggerimenti</h4>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li>Clicca su una parola nei risultati per cercare i suoi anagrammi</li>
                    <li>Tieni premuto (o tasto destro) per rimuovere una parola o cercare pattern</li>
                    <li>Usa "‚ûï Aggiungi" per aggiungere parole mancanti al dizionario locale</li>
                </ul>
                
                <p style="margin-top: 15px; color: #7f8c8d; font-size: 0.85em;">Vocabolario: <a href="http://www.enignet.it" target="_blank">Enilab/BEI</a> ‚Ä¢ App: <a href="https://github.com/infingardo" target="_blank">infingardo</a></p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-primary" onclick="closeHelp()" style="width: 100%;">Ho capito!</button>
            </div>
        </div>
    </div>

    <script>
        const DICT_BASE = 'https://infingardo.github.io/Enigmistica/';
        const DICT_FILES = { 
            ridotto: DICT_BASE + 'dizionario_ridotto.txt', 
            completo: DICT_BASE + 'dizionario_completo.txt' 
        };
        const CONTACT_EMAIL = 'critto@gmail.com';
        const CONTACT_NAME = 'kc8';
        const DB_NAME = 'AnagrammiBEI';
        const DB_VERSION = 1;
        const STORE_NAME = 'data';
        
        const VOWELS = 'aeiou√†√®√©√¨√≤√π';
        const CONSONANTS = 'bcdfghjklmnpqrstvwxyz';
        
        let db = null, dictIndex = null, wordSet = null, wordList = null, customWords = null, removedWords = null;
        let dictSize = 0, currentDict = null, selectedWord = null, longPressTimer = null;
        let currentTab = 'anagrammi';
        
        // Quiz state
        let quizActive = false;
        let quizWord = null;
        let quizAnagrams = [];
        let quizFound = [];
        let quizStreak = 0;
        let quizScore = 0;
        let quizCandidates = [];
        let quizTimer = null;
        let quizTimeLeft = 60;
        
        document.addEventListener('DOMContentLoaded', init);
        document.addEventListener('click', hideContextMenu);
        
        async function init() {
            try {
                db = await openDB();
                const saved = await dbGet('currentDict');
                if (saved) await loadDict(saved, true);
            } catch (err) { console.error('Init:', err); }
        }
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active', 
                    (tab === 'anagrammi' && i === 0) || 
                    (tab === 'ricerca' && i === 1) || 
                    (tab === 'quiz' && i === 2) ||
                    (tab === 'giochi' && i === 3)
                );
            });
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            if (tab !== 'quiz' && tab !== 'giochi') {
                document.getElementById('resultsCard').classList.add('hidden');
            }
        }
        
        let currentGame = 'cambi';
        
        function selectGame(game) {
            currentGame = game;
            document.querySelectorAll('.game-btn').forEach(btn => {
                const btnGame = btn.textContent.toLowerCase();
                btn.classList.toggle('active',
                    (game === 'cambi' && btnGame.includes('cambi')) ||
                    (game === 'palindromi' && btnGame.includes('palindromi')) ||
                    (game === 'bifronti' && btnGame.includes('bifronti')) ||
                    (game === 'scarti' && btnGame.includes('scarti')) ||
                    (game === 'zeppe' && btnGame.includes('zeppe')) ||
                    (game === 'aggiunte' && btnGame.includes('aggiunte')) ||
                    (game === 'sciarade' && btnGame.includes('sciarade'))
                );
            });
            document.querySelectorAll('.game-content').forEach(g => g.classList.remove('active'));
            document.getElementById(`game-${game}`).classList.add('active');
            document.getElementById('resultsCard').classList.add('hidden');
        }
        
        function openDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
                req.onupgradeneeded = (e) => {
                    if (!e.target.result.objectStoreNames.contains(STORE_NAME))
                        e.target.result.createObjectStore(STORE_NAME);
                };
            });
        }
        
        function dbGet(key) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const req = tx.objectStore(STORE_NAME).get(key);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
            });
        }
        
        function dbPut(key, value) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const req = tx.objectStore(STORE_NAME).put(value, key);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve();
            });
        }
        
        async function loadDict(type, fromCache = false) {
            currentDict = type;
            document.querySelectorAll('.dict-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(type));
            });
            
            customWords = new Set(await dbGet(`custom_${type}`) || []);
            removedWords = new Set(await dbGet(`removed_${type}`) || []);
            
            const cached = await dbGet(`dict_${type}`);
            if (cached && fromCache) {
                dictIndex = new Map(cached.index);
                wordSet = new Set(cached.words);
                wordList = cached.words;
                dictSize = cached.size;
                finishLoad();
            } else {
                await downloadDict(type);
            }
        }
        
        async function downloadDict(type) {
            const loader = document.getElementById('loadingIndicator');
            loader.classList.remove('hidden');
            updateLoadingText('Download vocabolario...');
            updateProgress(0);
            
            try {
                const res = await fetch(DICT_FILES[type]);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const text = await res.text();
                updateLoadingText('Elaborazione...');
                updateProgress(50);
                
                await processWords(text);
                
                for (const w of customWords) addWordToIndex(w);
                for (const w of removedWords) removeWordFromIndex(w);
                
                wordList = Array.from(wordSet);
                
                await dbPut(`dict_${type}`, { index: Array.from(dictIndex.entries()), words: wordList, size: dictSize });
                await dbPut('currentDict', type);
                
                loader.classList.add('hidden');
                finishLoad();
            } catch (err) {
                loader.classList.add('hidden');
                showError(`Errore: ${err.message}. Verifica la connessione.`);
            }
        }
        
        async function processWords(text) {
            const lines = text.split(/[\r\n]+/);
            dictIndex = new Map();
            wordSet = new Set();
            dictSize = 0;
            
            for (let i = 0; i < lines.length; i += 10000) {
                const batch = lines.slice(i, Math.min(i + 10000, lines.length));
                for (const line of batch) {
                    const word = line.trim().toLowerCase();
                    if (isValidWord(word)) addWordToIndex(word);
                }
                updateProgress(50 + (Math.min(i + 10000, lines.length) / lines.length) * 50);
                await new Promise(r => setTimeout(r, 0));
            }
        }
        
        function finishLoad() {
            document.getElementById('dictSelector').classList.add('hidden');
            document.getElementById('dictOptions').classList.remove('hidden');
            document.getElementById('inputWord').disabled = false;
            document.getElementById('inputPattern').disabled = false;
            document.getElementById('btnSearch').disabled = false;
            document.getElementById('btnPattern').disabled = false;
            document.getElementById('btnAddWord').disabled = false;
            document.getElementById('btnStartQuiz').disabled = false;
            document.getElementById('btnCambi').disabled = false;
            document.getElementById('btnPalindromi').disabled = false;
            document.getElementById('btnBifronti').disabled = false;
            document.getElementById('btnScarti').disabled = false;
            document.getElementById('btnZeppe').disabled = false;
            document.getElementById('btnAggiunte').disabled = false;
            document.getElementById('btnSciarade').disabled = false;
            document.getElementById('btnSciaradeInv').disabled = false;
            document.getElementById('inputWord').focus();
            
            const label = currentDict === 'ridotto' ? 'üìò Ridotto' : 'üìö Completo';
            updateStatus('loaded', `‚úÖ ${label} (${formatNumber(dictSize)} parole)`);
            updateCustomWordsCount();
            
            // Pre-build quiz candidates
            buildQuizCandidates();
        }
        
        function switchDict() {
            document.getElementById('dictSelector').classList.remove('hidden');
            document.getElementById('dictOptions').classList.add('hidden');
            document.getElementById('resultsCard').classList.add('hidden');
            document.getElementById('inputWord').disabled = true;
            document.getElementById('inputPattern').disabled = true;
            document.getElementById('btnSearch').disabled = true;
            document.getElementById('btnPattern').disabled = true;
            document.getElementById('btnStartQuiz').disabled = true;
            document.getElementById('btnCambi').disabled = true;
            document.getElementById('btnPalindromi').disabled = true;
            document.getElementById('btnBifronti').disabled = true;
            document.getElementById('btnScarti').disabled = true;
            document.getElementById('btnZeppe').disabled = true;
            document.getElementById('btnAggiunte').disabled = true;
            document.getElementById('btnSciarade').disabled = true;
            document.getElementById('btnSciaradeInv').disabled = true;
            endQuiz();
            updateStatus('', '‚è≥ Seleziona un vocabolario...');
        }
        
        function isValidWord(word) { return word && word.length >= 2 && /^[a-z√†√®√©√¨√≤√π√¢√™√Æ√¥√ª√§√´√Ø√∂√º√ß'-]+$/i.test(word); }
        
        function addWordToIndex(word) {
            const clean = word.replace(/['-]/g, '');
            if (clean.length < 2) return false;
            const sig = getSignature(clean);
            if (!dictIndex.has(sig)) dictIndex.set(sig, []);
            if (!wordSet.has(word)) {
                dictIndex.get(sig).push(word);
                wordSet.add(word);
                dictSize++;
                return true;
            }
            return false;
        }
        
        function removeWordFromIndex(word) {
            if (!wordSet.has(word)) return false;
            const sig = getSignature(word.replace(/['-]/g, ''));
            wordSet.delete(word);
            dictSize--;
            if (dictIndex.has(sig)) {
                const words = dictIndex.get(sig).filter(w => w !== word);
                if (words.length === 0) dictIndex.delete(sig);
                else dictIndex.set(sig, words);
            }
            return true;
        }
        
        async function saveCustomData() {
            wordList = Array.from(wordSet);
            await dbPut(`custom_${currentDict}`, Array.from(customWords));
            await dbPut(`removed_${currentDict}`, Array.from(removedWords));
            await dbPut(`dict_${currentDict}`, { index: Array.from(dictIndex.entries()), words: wordList, size: dictSize });
        }
        
        // Pattern search
        function patternToRegex(pattern) {
            let regex = '^';
            for (const char of pattern.toLowerCase()) {
                if (char === '.' || char === '?') {
                    regex += '[a-z√†√®√©√¨√≤√π√¢√™√Æ√¥√ª√§√´√Ø√∂√º√ß]';
                } else if (char === '+') {
                    regex += `[${VOWELS}]`;
                } else if (char === '-') {
                    regex += `[${CONSONANTS}]`;
                } else if (char === '*') {
                    regex += '[a-z√†√®√©√¨√≤√π√¢√™√Æ√¥√ª√§√´√Ø√∂√º√ß]*';
                } else if (/[a-z√†√®√©√¨√≤√π√¢√™√Æ√¥√ª√§√´√Ø√∂√º√ß]/.test(char)) {
                    regex += char;
                }
            }
            regex += '$';
            return new RegExp(regex, 'i');
        }
        
        function searchPattern() {
            const pattern = document.getElementById('inputPattern').value.trim();
            if (!pattern) return;
            
            const minLen = parseInt(document.getElementById('selMinLenSearch').value);
            const maxLen = parseInt(document.getElementById('selMaxLenSearch').value);
            
            let regex;
            try {
                regex = patternToRegex(pattern);
            } catch (e) {
                alert('Pattern non valido');
                return;
            }
            
            const results = [];
            for (const word of wordList) {
                if (word.length < minLen || word.length > maxLen) continue;
                if (regex.test(word)) {
                    results.push(word);
                    if (results.length >= 1000) break;
                }
            }
            
            results.sort((a, b) => a.length - b.length || a.localeCompare(b));
            displayPatternResults(pattern, results);
        }
        
        function displayPatternResults(pattern, results) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            
            document.getElementById('resultsCount').textContent = `${results.length}${results.length >= 1000 ? '+' : ''} risultat${results.length === 1 ? 'o' : 'i'} per "${pattern}"`;
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">Nessuna parola trovata üòï</div>';
                card.classList.remove('hidden');
                return;
            }
            
            const byLen = {};
            for (const w of results) {
                const len = w.length;
                if (!byLen[len]) byLen[len] = [];
                byLen[len].push(w);
            }
            
            const lengths = Object.keys(byLen).map(Number).sort((a, b) => a - b);
            
            let html = `<div class="results-section">
                ${lengths.map(len => `
                    <div class="length-group">
                        <div class="length-label">${len} lettere (${byLen[len].length})</div>
                        <div class="results-grid">${byLen[len].map(w => wordSpan(w)).join('')}</div>
                    </div>
                `).join('')}
            </div>`;
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        // Word management
        function showAddWordModal() {
            document.getElementById('addWordModal').classList.remove('hidden');
            document.getElementById('newWordInput').value = '';
            document.getElementById('newWordInput').focus();
        }
        
        function closeAddWordModal() { document.getElementById('addWordModal').classList.add('hidden'); }
        function handleAddWordKeyUp(e) { if (e.key === 'Enter') addWord(); if (e.key === 'Escape') closeAddWordModal(); }
        
        async function addWord() {
            const word = document.getElementById('newWordInput').value.trim().toLowerCase();
            if (!word) { alert('Inserisci una parola'); return; }
            if (!isValidWord(word)) { alert('Parola non valida'); return; }
            if (wordSet.has(word)) { alert('Gi√† presente'); closeAddWordModal(); return; }
            
            removedWords.delete(word);
            addWordToIndex(word);
            customWords.add(word);
            await saveCustomData();
            
            closeAddWordModal();
            updateStatus('loaded', `‚úÖ ${currentDict === 'ridotto' ? 'üìò Ridotto' : 'üìö Completo'} (${formatNumber(dictSize)} parole)`);
            updateCustomWordsCount();
            showSuccess(`"${word}" aggiunta!`);
        }
        
        async function removeWord(word) {
            if (!wordSet.has(word)) return;
            removeWordFromIndex(word);
            removedWords.add(word);
            customWords.delete(word);
            await saveCustomData();
            
            updateStatus('loaded', `‚úÖ ${currentDict === 'ridotto' ? 'üìò Ridotto' : 'üìö Completo'} (${formatNumber(dictSize)} parole)`);
            updateCustomWordsCount();
            showSuccess(`"${word}" rimossa`);
            if (!document.getElementById('resultsCard').classList.contains('hidden')) {
                if (currentTab === 'anagrammi') findAnagrams();
                else searchPattern();
            }
        }
        
        async function restoreRemoved() {
            if (removedWords.size === 0) { alert('Niente da ripristinare'); return; }
            if (!confirm(`Ripristinare ${removedWords.size} parole?`)) return;
            for (const w of removedWords) addWordToIndex(w);
            removedWords.clear();
            await saveCustomData();
            updateStatus('loaded', `‚úÖ ${currentDict === 'ridotto' ? 'üìò Ridotto' : 'üìö Completo'} (${formatNumber(dictSize)} parole)`);
            updateCustomWordsCount();
            showSuccess('Ripristinate!');
        }
        
        function updateCustomWordsCount() {
            const el = document.getElementById('customWordsCount');
            const parts = [];
            if (customWords.size > 0) parts.push(`+${customWords.size} aggiunte`);
            if (removedWords.size > 0) parts.push(`-${removedWords.size} rimosse`);
            el.textContent = parts.length > 0 ? `üìù ${parts.join(', ')}` : '';
        }
        
        // Context menu
        function showContextMenu(e, word) {
            e.preventDefault();
            selectedWord = word;
            const menu = document.getElementById('contextMenu');
            menu.classList.remove('hidden');
            menu.style.left = Math.min(e.clientX || 0, window.innerWidth - 160) + 'px';
            menu.style.top = Math.min(e.clientY || 0, window.innerHeight - 100) + 'px';
        }
        
        function hideContextMenu() { document.getElementById('contextMenu').classList.add('hidden'); selectedWord = null; }
        
        function searchSelectedWord() { 
            if (selectedWord) { 
                switchTab('anagrammi');
                document.getElementById('inputWord').value = selectedWord; 
                findAnagrams(); 
            } 
            hideContextMenu(); 
        }
        
        function patternSelectedWord() {
            if (selectedWord) {
                switchTab('ricerca');
                document.getElementById('inputPattern').value = selectedWord;
            }
            hideContextMenu();
        }
        
        function removeSelectedWord() { if (selectedWord) removeWord(selectedWord); hideContextMenu(); }
        function handleWordTouchStart(e, word) { longPressTimer = setTimeout(() => showContextMenu(e, word), 500); }
        function handleWordTouchEnd() { clearTimeout(longPressTimer); }
        
        // Export & Suggest
        function exportDictionary() {
            const words = Array.from(wordSet).sort();
            const blob = new Blob([words.join('\n')], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `dizionario_${currentDict}.txt`;
            a.click();
            showSuccess(`Esportate ${formatNumber(words.length)} parole`);
        }
        
        function suggestWord() {
            document.getElementById('suggestModal').classList.remove('hidden');
            document.getElementById('suggestWordInput').value = '';
            document.getElementById('suggestWordInput').focus();
        }
        
        function closeSuggestModal() { document.getElementById('suggestModal').classList.add('hidden'); }

        function showHelp() { document.getElementById('helpModal').classList.remove('hidden'); }
        function closeHelp() { document.getElementById('helpModal').classList.add('hidden'); }
        
        function sendSuggestion() {
            const word = document.getElementById('suggestWordInput').value.trim();
            if (!word) { alert('Inserisci una parola'); return; }
            window.location.href = `mailto:${CONTACT_EMAIL}?subject=${encodeURIComponent(`Suggerimento: ${word}`)}&body=${encodeURIComponent(`Caro ${CONTACT_NAME},\n\nti suggerisco di aggiungere:\n\n${word}\n\nGrazie!`)}`;
            closeSuggestModal();
        }
        
        function closeModalOnOverlay(e) { if (e.target.classList.contains('modal-overlay')) e.target.classList.add('hidden'); }
        
        // Anagrams
        function getSignature(word) { return word.toLowerCase().replace(/['-]/g, '').split('').sort().join(''); }
        
        function findAnagrams() {
            const input = document.getElementById('inputWord').value.trim().toLowerCase();
            if (!input) return;
            
            const clean = input.replace(/[^a-z√†√®√©√¨√≤√π√¢√™√Æ√¥√ª√§√´√Ø√∂√º√ß]/gi, '');
            if (clean.length < 2) { alert('Almeno 2 lettere'); return; }
            
            const minLen = parseInt(document.getElementById('selMinLen').value);
            const multiWord = document.getElementById('chkMulti').checked;
            const showPartial = document.getElementById('chkPartial').checked;
            const maxWords = parseInt(document.getElementById('selMaxWords').value);
            
            const single = (dictIndex.get(getSignature(clean)) || []).filter(w => w.toLowerCase() !== clean);
            let multi = multiWord && clean.length <= 15 ? findMultiWordAnagrams(clean, maxWords, minLen) : [];
            let partial = showPartial ? findPartialAnagrams(clean, minLen) : [];
            
            displayAnagramResults(clean, single, multi, partial);
        }
        
        function findPartialAnagrams(input, minLen) {
            const results = [];
            const lc = {};
            for (const l of input) lc[l] = (lc[l] || 0) + 1;
            
            for (const word of wordSet) {
                const clean = word.replace(/['-]/g, '');
                if (clean.length >= input.length || clean.length < minLen) continue;
                
                const wc = {};
                let valid = true;
                for (const l of clean) { wc[l] = (wc[l] || 0) + 1; if (wc[l] > (lc[l] || 0)) { valid = false; break; } }
                if (valid) results.push(word);
            }
            
            results.sort((a, b) => b.length - a.length || a.localeCompare(b));
            return results;
        }
        
        function findMultiWordAnagrams(input, maxWords, minLen) {
            const results = [], letters = input.split('').sort(), seen = new Set();
            const candidates = findCandidates(letters, minLen);
            
            function search(rem, cur, depth) {
                if (rem.length === 0 && cur.length >= 2) {
                    const key = [...cur].sort().join(' ');
                    if (!seen.has(key)) { seen.add(key); results.push([...cur]); }
                    return;
                }
                if (depth >= maxWords || results.length >= 500) return;
                
                for (const word of candidates) {
                    const wl = word.replace(/['-]/g, '').split('').sort();
                    if (wl.length > rem.length || wl.length < minLen) continue;
                    const newRem = trySubtract(rem, wl);
                    if (newRem) { cur.push(word); search(newRem, cur, depth + 1); cur.pop(); }
                }
            }
            
            search(letters, [], 0);
            return results;
        }
        
        function findCandidates(letters, minLen) {
            const candidates = [], lc = {};
            for (const l of letters) lc[l] = (lc[l] || 0) + 1;
            
            for (const word of wordSet) {
                if (word.length < minLen) continue;
                const clean = word.replace(/['-]/g, '');
                if (clean.length > letters.length) continue;
                
                const wc = {};
                let valid = true;
                for (const l of clean) { wc[l] = (wc[l] || 0) + 1; if (wc[l] > (lc[l] || 0)) { valid = false; break; } }
                if (valid) candidates.push(word);
            }
            
            candidates.sort((a, b) => b.length - a.length);
            return candidates;
        }
        
        function trySubtract(arr, toRemove) {
            const result = [...arr];
            for (const item of toRemove) { const idx = result.indexOf(item); if (idx === -1) return null; result.splice(idx, 1); }
            return result;
        }
        
        function displayAnagramResults(input, single, multi, partial) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            const total = single.length + multi.length + partial.length;
            
            document.getElementById('resultsCount').textContent = `${total} risultat${total === 1 ? 'o' : 'i'} per "${input}"`;
            
            let html = '';
            
            html += `<div class="results-section"><h4>üéØ Anagrammi perfetti (${single.length})</h4>`;
            if (single.length > 0) {
                html += `<div class="results-grid">${single.map(w => wordSpan(w)).join('')}</div>`;
            } else {
                html += `<div class="no-results-small">Nessuno</div>`;
            }
            html += `</div>`;
            
            if (document.getElementById('chkMulti').checked) {
                html += `<div class="results-section"><h4>üîó Multi-parola (${multi.length})</h4>`;
                if (multi.length > 0) {
                    html += `<div class="results-grid">${multi.map(arr => `<span class="result-word result-multi">${arr.map(escapeHtml).join(' + ')}</span>`).join('')}</div>`;
                } else {
                    html += `<div class="no-results-small">Nessuno</div>`;
                }
                html += `</div>`;
            }
            
            if (document.getElementById('chkPartial').checked) {
                html += `<div class="results-section"><h4>üì¶ Parole incluse (${partial.length})</h4>`;
                if (partial.length > 0) {
                    const byLen = {};
                    for (const w of partial) { const len = w.replace(/['-]/g, '').length; if (!byLen[len]) byLen[len] = []; byLen[len].push(w); }
                    const lengths = Object.keys(byLen).map(Number).sort((a, b) => b - a);
                    html += lengths.map(len => `<div class="length-group"><div class="length-label">${len} lettere (${byLen[len].length})</div><div class="results-grid">${byLen[len].map(w => wordSpan(w, 'result-partial')).join('')}</div></div>`).join('');
                } else {
                    html += `<div class="no-results-small">Nessuna</div>`;
                }
                html += `</div>`;
            }
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        function wordSpan(word, extra = '') {
            const isCustom = customWords.has(word);
            const cls = `result-word ${extra} ${isCustom ? 'result-custom' : ''}`.trim();
            const esc = escapeHtml(word);
            return `<span class="${cls}" onclick="searchWord('${esc}')" oncontextmenu="showContextMenu(event, '${esc}')" ontouchstart="handleWordTouchStart(event, '${esc}')" ontouchend="handleWordTouchEnd()" ontouchmove="handleWordTouchEnd()">${esc}</span>`;
        }
        
        function searchWord(word) { 
            switchTab('anagrammi');
            document.getElementById('inputWord').value = word; 
            findAnagrams(); 
        }
        
        function escapeHtml(str) { return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
        
        function updateStatus(type, text) { document.getElementById('dictStatus').className = 'status ' + type; document.getElementById('statusText').textContent = text; }
        function updateLoadingText(text) { document.getElementById('loadingText').textContent = text; }
        function updateProgress(percent) { document.getElementById('progressFill').style.width = percent + '%'; }
        
        function showError(msg) { const el = document.getElementById('infoMessage'); el.textContent = msg; el.className = 'info-message error'; el.classList.remove('hidden'); }
        function showSuccess(msg) { const el = document.getElementById('infoMessage'); el.textContent = msg; el.className = 'info-message success'; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 2500); }
        function handleKeyUp(e, tab) { if (e.key === 'Enter') { if (tab === 'anagrammi') findAnagrams(); else searchPattern(); } }
        function formatNumber(n) { return n.toLocaleString('it-IT'); }
        
        // ==================== QUIZ ====================
        
        function buildQuizCandidates() {
            quizCandidates = [];
            for (const [sig, words] of dictIndex.entries()) {
                if (words.length >= 2) {
                    for (const w of words) {
                        const clean = w.replace(/['-]/g, '');
                        quizCandidates.push({
                            word: w,
                            clean: clean,
                            length: clean.length,
                            anagramCount: words.length - 1,
                            signature: sig
                        });
                    }
                }
            }
            console.log(`Quiz: ${quizCandidates.length} parole con anagrammi`);
        }
        
        function startQuiz() {
            const minLen = parseInt(document.getElementById('selQuizMinLen').value);
            const maxLen = parseInt(document.getElementById('selQuizMaxLen').value);
            const minAnagrams = parseInt(document.getElementById('selQuizMinAnagrams').value);
            
            const filtered = quizCandidates.filter(c => 
                c.length >= minLen && 
                c.length <= maxLen && 
                c.anagramCount >= minAnagrams
            );
            
            if (filtered.length === 0) {
                alert('Nessuna parola trovata con questi criteri. Prova a cambiare i filtri.');
                return;
            }
            
            quizActive = true;
            quizStreak = 0;
            quizScore = 0;
            
            document.getElementById('quizStart').classList.add('hidden');
            document.getElementById('quizGame').classList.remove('hidden');
            document.getElementById('quizInput').disabled = false;
            
            updateQuizStats();
            nextQuizWord(filtered, minLen, maxLen, minAnagrams);
        }
        
        function nextQuizWord(filtered, minLen, maxLen, minAnagrams) {
            // Stop existing timer
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            if (!filtered) {
                minLen = parseInt(document.getElementById('selQuizMinLen').value);
                maxLen = parseInt(document.getElementById('selQuizMaxLen').value);
                minAnagrams = parseInt(document.getElementById('selQuizMinAnagrams').value);
                filtered = quizCandidates.filter(c => 
                    c.length >= minLen && 
                    c.length <= maxLen && 
                    c.anagramCount >= minAnagrams
                );
            }
            
            const candidate = filtered[Math.floor(Math.random() * filtered.length)];
            quizWord = candidate.word;
            
            // Single word anagrams
            const allAnagrams = dictIndex.get(candidate.signature) || [];
            let singleAnagrams = allAnagrams.filter(w => w.toLowerCase() !== quizWord.toLowerCase());
            
            // Multi-word anagrams for words >= 7 letters
            let multiAnagrams = [];
            const cleanWord = quizWord.replace(/['-]/g, '');
            if (cleanWord.length >= 7) {
                const maxWords = cleanWord.length >= 10 ? 3 : 2;
                const minLen = 3;
                const multiResults = findMultiWordAnagrams(cleanWord, maxWords, minLen);
                // Limit to max 10 multi-word combinations for quiz
                multiAnagrams = multiResults.slice(0, 10).map(arr => arr.join(' + '));
            }
            
            // Combine: single words + multi-word combinations
            quizAnagrams = [...singleAnagrams, ...multiAnagrams];
            quizFound = [];
            
            document.getElementById('quizWord').textContent = quizWord.toUpperCase();
            const multiCount = multiAnagrams.length;
            let promptText = `Trova ${quizAnagrams.length} anagramm${quizAnagrams.length === 1 ? 'a' : 'i'}`;
            if (multiCount > 0) {
                promptText += ` (${multiCount} multi-parola)`;
            }
            document.getElementById('quizPrompt').textContent = promptText;
            document.getElementById('quizFound').innerHTML = '';
            document.getElementById('quizProgressFill').style.width = '0%';
            document.getElementById('quizFeedback').textContent = '\u00A0';
            document.getElementById('quizFeedback').className = 'quiz-feedback empty';
            document.getElementById('quizInput').value = '';
            document.getElementById('quizInput').focus();
            
            // Start timer
            quizTimeLeft = 60;
            updateTimerDisplay();
            quizTimer = setInterval(quizTick, 1000);
        }
        
        function quizTick() {
            quizTimeLeft--;
            updateTimerDisplay();
            
            if (quizTimeLeft <= 0) {
                clearInterval(quizTimer);
                quizTimer = null;
                quizTimeout();
            }
        }
        
        function updateTimerDisplay() {
            const el = document.getElementById('quizTimer');
            el.textContent = quizTimeLeft;
            el.classList.toggle('warning', quizTimeLeft <= 10);
        }
        
        function quizTimeout() {
            const missed = quizAnagrams.filter(w => !quizFound.map(f => f.toLowerCase()).includes(w.toLowerCase()));
            const foundEl = document.getElementById('quizFound');
            
            for (const word of missed) {
                foundEl.innerHTML += `<span class="quiz-found-word missed">${escapeHtml(word)}</span>`;
            }
            
            quizStreak = 0;
            updateQuizStats();
            
            document.getElementById('quizFeedback').textContent = '‚è±Ô∏è Tempo scaduto!';
            document.getElementById('quizFeedback').className = 'quiz-feedback wrong';
            document.getElementById('quizProgressFill').style.width = '100%';
            
            setTimeout(() => {
                if (quizActive) nextQuizWord();
            }, 2500);
        }
        
        function handleQuizKeyUp(e) {
            if (e.key === 'Enter') {
                checkQuizAnswer();
            }
        }
        
        function checkQuizAnswer() {
            const rawInput = document.getElementById('quizInput').value.trim().toLowerCase();
            const feedback = document.getElementById('quizFeedback');
            
            if (!rawInput) return;
            
            document.getElementById('quizInput').value = '';
            
            // Normalize input: handle "parola1 + parola2" or "parola1 parola2"
            const normalizeAnswer = (str) => {
                return str.toLowerCase()
                    .split(/[\s+]+/)
                    .filter(w => w.length > 0)
                    .sort()
                    .join(' + ');
            };
            
            const normalizedInput = normalizeAnswer(rawInput);
            
            // Check if already found
            const foundNormalized = quizFound.map(f => normalizeAnswer(f));
            if (foundNormalized.includes(normalizedInput)) {
                feedback.textContent = 'üîÑ Gi√† trovata!';
                feedback.className = 'quiz-feedback duplicate';
                return;
            }
            
            // Check if it's a valid anagram
            const anagramsNormalized = quizAnagrams.map(a => normalizeAnswer(a));
            const matchIndex = anagramsNormalized.indexOf(normalizedInput);
            
            if (matchIndex !== -1) {
                const original = quizAnagrams[matchIndex];
                quizFound.push(original);
                quizScore += 10;
                
                const foundEl = document.getElementById('quizFound');
                foundEl.innerHTML += `<span class="quiz-found-word">${escapeHtml(original)}</span>`;
                
                const progress = (quizFound.length / quizAnagrams.length) * 100;
                document.getElementById('quizProgressFill').style.width = progress + '%';
                
                if (quizFound.length === quizAnagrams.length) {
                    // Stop timer
                    if (quizTimer) {
                        clearInterval(quizTimer);
                        quizTimer = null;
                    }
                    
                    quizStreak++;
                    quizScore += quizAnagrams.length * 5;
                    // Time bonus: more points for faster completion
                    quizScore += quizTimeLeft;
                    updateQuizStats();
                    
                    feedback.textContent = `üéâ Perfetto! +${quizTimeLeft} bonus tempo`;
                    feedback.className = 'quiz-feedback correct';
                    
                    setTimeout(() => {
                        if (quizActive) nextQuizWord();
                    }, 1500);
                } else {
                    feedback.textContent = `‚úÖ Bravo! Ancora ${quizAnagrams.length - quizFound.length}`;
                    feedback.className = 'quiz-feedback correct';
                }
                
                updateQuizStats();
            } else {
                feedback.textContent = `‚ùå "${rawInput}" non √® un anagramma`;
                feedback.className = 'quiz-feedback wrong';
            }
        }
        
        function skipQuizWord() {
            // Stop timer
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            const missed = quizAnagrams.filter(w => !quizFound.map(f => f.toLowerCase()).includes(w.toLowerCase()));
            const foundEl = document.getElementById('quizFound');
            
            for (const word of missed) {
                foundEl.innerHTML += `<span class="quiz-found-word missed">${escapeHtml(word)}</span>`;
            }
            
            quizStreak = 0;
            updateQuizStats();
            
            document.getElementById('quizFeedback').textContent = '‚è≠Ô∏è Passato! Ecco le soluzioni mancanti';
            document.getElementById('quizFeedback').className = 'quiz-feedback wrong';
            document.getElementById('quizProgressFill').style.width = '100%';
            
            setTimeout(() => {
                if (quizActive) nextQuizWord();
            }, 2000);
        }
        
        function endQuiz() {
            // Stop timer
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            quizActive = false;
            document.getElementById('quizStart').classList.remove('hidden');
            document.getElementById('quizGame').classList.add('hidden');
            document.getElementById('quizInput').disabled = true;
        }
        
        function updateQuizStats() {
            document.getElementById('quizStreak').textContent = quizStreak;
            document.getElementById('quizScore').textContent = quizScore;
        }
        
        // ==================== GIOCHI ====================
        
        // Cambi: trova catena di parole cambiando una lettera alla volta (BFS)
        function findCambi() {
            const start = document.getElementById('cambiStart').value.trim().toLowerCase();
            const end = document.getElementById('cambiEnd').value.trim().toLowerCase();
            
            if (!start || !end) {
                alert('Inserisci entrambe le parole');
                return;
            }
            
            if (start.length !== end.length) {
                alert('Le parole devono avere la stessa lunghezza');
                return;
            }
            
            if (!wordSet.has(start)) {
                alert(`"${start}" non √® nel dizionario`);
                return;
            }
            
            if (!wordSet.has(end)) {
                alert(`"${end}" non √® nel dizionario`);
                return;
            }
            
            if (start === end) {
                alert('Le parole devono essere diverse');
                return;
            }
            
            // Build graph of words with same length
            const len = start.length;
            const wordsOfLen = Array.from(wordSet).filter(w => w.replace(/['-]/g, '').length === len);
            
            // BFS to find shortest path
            const queue = [[start]];
            const visited = new Set([start]);
            let found = null;
            
            while (queue.length > 0 && !found) {
                const path = queue.shift();
                const current = path[path.length - 1];
                
                // Find neighbors (words differing by one letter)
                for (const word of wordsOfLen) {
                    if (visited.has(word)) continue;
                    
                    if (differsByOne(current, word)) {
                        const newPath = [...path, word];
                        
                        if (word === end) {
                            found = newPath;
                            break;
                        }
                        
                        visited.add(word);
                        queue.push(newPath);
                    }
                }
                
                // Limit search to avoid hanging
                if (visited.size > 10000) break;
            }
            
            displayCambiResults(start, end, found);
        }
        
        function differsByOne(a, b) {
            if (a.length !== b.length) return false;
            let diff = 0;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) diff++;
                if (diff > 1) return false;
            }
            return diff === 1;
        }
        
        function displayCambiResults(start, end, path) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            
            if (!path) {
                document.getElementById('resultsCount').textContent = `Nessuna catena trovata`;
                container.innerHTML = `<div class="no-results">Impossibile collegare "${start.toUpperCase()}" a "${end.toUpperCase()}" üòï</div>`;
                card.classList.remove('hidden');
                return;
            }
            
            document.getElementById('resultsCount').textContent = `Catena di ${path.length} parole (${path.length - 1} cambi)`;
            
            let html = '<div class="cambi-chain">';
            path.forEach((word, i) => {
                let cls = 'cambi-step';
                if (i === 0) cls += ' start';
                else if (i === path.length - 1) cls += ' end';
                
                html += `<span class="${cls}">${escapeHtml(word)}</span>`;
                if (i < path.length - 1) {
                    html += '<span class="cambi-step-arrow">‚Üí</span>';
                }
            });
            html += '</div>';
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        // Palindromi: trova parole che si leggono uguali al contrario
        function findPalindromi() {
            const minLen = parseInt(document.getElementById('selPalMinLen').value);
            const maxLen = parseInt(document.getElementById('selPalMaxLen').value);
            
            const results = [];
            
            for (const word of wordSet) {
                const clean = word.replace(/['-]/g, '').toLowerCase();
                if (clean.length < minLen || clean.length > maxLen) continue;
                
                if (isPalindrome(clean)) {
                    results.push(word);
                }
            }
            
            results.sort((a, b) => {
                const lenDiff = a.length - b.length;
                return lenDiff !== 0 ? lenDiff : a.localeCompare(b);
            });
            
            displayPalindromiResults(results);
        }
        
        function isPalindrome(str) {
            const len = str.length;
            for (let i = 0; i < len / 2; i++) {
                if (str[i] !== str[len - 1 - i]) return false;
            }
            return true;
        }
        
        function displayPalindromiResults(results) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            
            document.getElementById('resultsCount').textContent = `${results.length} palindrom${results.length === 1 ? 'o' : 'i'}`;
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">Nessun palindromo trovato üòï</div>';
                card.classList.remove('hidden');
                return;
            }
            
            // Group by length
            const byLen = {};
            for (const w of results) {
                const len = w.replace(/['-]/g, '').length;
                if (!byLen[len]) byLen[len] = [];
                byLen[len].push(w);
            }
            
            const lengths = Object.keys(byLen).map(Number).sort((a, b) => a - b);
            
            let html = `<div class="results-section">
                ${lengths.map(len => `
                    <div class="length-group">
                        <div class="length-label">${len} lettere (${byLen[len].length})</div>
                        <div class="results-grid">${byLen[len].map(w => wordSpan(w)).join('')}</div>
                    </div>
                `).join('')}
            </div>`;
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        // Bifronti: trova coppie di parole una il rovescio dell'altra
        function findBifronti() {
            const minLen = parseInt(document.getElementById('selBifMinLen').value);
            const maxLen = parseInt(document.getElementById('selBifMaxLen').value);
            
            const results = [];
            const seen = new Set();
            
            for (const word of wordSet) {
                const clean = word.replace(/['-]/g, '').toLowerCase();
                if (clean.length < minLen || clean.length > maxLen) continue;
                
                const reversed = clean.split('').reverse().join('');
                
                // Skip palindromes
                if (reversed === clean) continue;
                
                // Check if reversed word exists
                if (wordSet.has(reversed)) {
                    const key = [clean, reversed].sort().join('|');
                    if (!seen.has(key)) {
                        seen.add(key);
                        // Find original case versions
                        const orig1 = Array.from(wordSet).find(w => w.replace(/['-]/g, '').toLowerCase() === clean) || word;
                        const orig2 = Array.from(wordSet).find(w => w.replace(/['-]/g, '').toLowerCase() === reversed) || reversed;
                        results.push([orig1, orig2]);
                    }
                }
            }
            
            results.sort((a, b) => {
                const lenDiff = a[0].length - b[0].length;
                return lenDiff !== 0 ? lenDiff : a[0].localeCompare(b[0]);
            });
            
            displayBifrontiResults(results);
        }
        
        function displayBifrontiResults(results) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            
            document.getElementById('resultsCount').textContent = `${results.length} copp${results.length === 1 ? 'ia' : 'ie'} di bifronti`;
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">Nessun bifronte trovato üòï</div>';
                card.classList.remove('hidden');
                return;
            }
            
            // Group by length
            const byLen = {};
            for (const pair of results) {
                const len = pair[0].replace(/['-]/g, '').length;
                if (!byLen[len]) byLen[len] = [];
                byLen[len].push(pair);
            }
            
            const lengths = Object.keys(byLen).map(Number).sort((a, b) => a - b);
            
            let html = `<div class="results-section">
                ${lengths.map(len => `
                    <div class="length-group">
                        <div class="length-label">${len} lettere (${byLen[len].length})</div>
                        <div class="results-grid">
                            ${byLen[len].map(pair => `
                                <span class="bifronte-pair">
                                    <span onclick="searchWord('${escapeHtml(pair[0])}')" style="cursor:pointer">${escapeHtml(pair[0])}</span>
                                    <span class="bifronte-arrow">‚Üî</span>
                                    <span onclick="searchWord('${escapeHtml(pair[1])}')" style="cursor:pointer">${escapeHtml(pair[1])}</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>`;
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        // Scarti: togli una lettera da una parola per formarne un'altra
        function findScarti() {
            const input = document.getElementById('scartiInput').value.trim().toLowerCase();
            
            if (!input) {
                alert('Inserisci una parola');
                return;
            }
            
            if (!wordSet.has(input)) {
                alert(`"${input}" non √® nel dizionario`);
                return;
            }
            
            const results = [];
            const clean = input.replace(/['-]/g, '');
            
            // Try removing each letter
            for (let i = 0; i < clean.length; i++) {
                const shortened = clean.slice(0, i) + clean.slice(i + 1);
                if (shortened.length >= 2 && wordSet.has(shortened)) {
                    const removedLetter = clean[i].toUpperCase();
                    const position = i === 0 ? 'inizio' : i === clean.length - 1 ? 'fine' : `pos ${i + 1}`;
                    results.push({
                        word: shortened,
                        removed: removedLetter,
                        position: position,
                        posIndex: i
                    });
                }
            }
            
            displayScartiResults(input, results);
        }
        
        function displayScartiResults(input, results) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            
            document.getElementById('resultsCount').textContent = `${results.length} scart${results.length === 1 ? 'o' : 'i'} per "${input.toUpperCase()}"`;
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">Nessuno scarto trovato üòï</div>';
                card.classList.remove('hidden');
                return;
            }
            
            let html = '<div class="results-section"><div class="results-grid">';
            for (const r of results) {
                html += `<span class="result-word" onclick="searchWord('${escapeHtml(r.word)}')" style="cursor:pointer">
                    <strong>‚àí${r.removed}</strong> ‚Üí ${escapeHtml(r.word.toUpperCase())}
                </span>`;
            }
            html += '</div></div>';
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        // Zeppe: aggiungi una lettera dentro una parola per formarne un'altra
        function findZeppe() {
            const input = document.getElementById('zeppeInput').value.trim().toLowerCase();
            
            if (!input) {
                alert('Inserisci una parola');
                return;
            }
            
            if (!wordSet.has(input)) {
                alert(`"${input}" non √® nel dizionario`);
                return;
            }
            
            const results = [];
            const clean = input.replace(/['-]/g, '');
            const alphabet = 'abcdefghijklmnopqrstuvwxyz√†√®√©√¨√≤√π';
            
            // Try adding each letter at each position (excluding start and end - those are "aggiunte")
            for (let i = 1; i < clean.length; i++) {
                for (const letter of alphabet) {
                    const zeppata = clean.slice(0, i) + letter + clean.slice(i);
                    if (wordSet.has(zeppata)) {
                        results.push({
                            word: zeppata,
                            added: letter.toUpperCase(),
                            position: i
                        });
                    }
                }
            }
            
            // Remove duplicates
            const unique = [];
            const seen = new Set();
            for (const r of results) {
                if (!seen.has(r.word)) {
                    seen.add(r.word);
                    unique.push(r);
                }
            }
            
            displayZeppeResults(input, unique);
        }
        
        function displayZeppeResults(input, results) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            
            document.getElementById('resultsCount').textContent = `${results.length} zepp${results.length === 1 ? 'a' : 'e'} per "${input.toUpperCase()}"`;
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">Nessuna zeppa trovata üòï</div>';
                card.classList.remove('hidden');
                return;
            }
            
            let html = '<div class="results-section"><div class="results-grid">';
            for (const r of results) {
                html += `<span class="result-word" onclick="searchWord('${escapeHtml(r.word)}')" style="cursor:pointer">
                    <strong>+${r.added}</strong> ‚Üí ${escapeHtml(r.word.toUpperCase())}
                </span>`;
            }
            html += '</div></div>';
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        // Aggiunte: aggiungi una lettera all'inizio o alla fine
        function findAggiunte() {
            const input = document.getElementById('aggiunteInput').value.trim().toLowerCase();
            
            if (!input) {
                alert('Inserisci una parola');
                return;
            }
            
            if (!wordSet.has(input)) {
                alert(`"${input}" non √® nel dizionario`);
                return;
            }
            
            const checkInizio = document.getElementById('chkAggiuntaInizio').checked;
            const checkFine = document.getElementById('chkAggiuntaFine').checked;
            
            const inizioResults = [];
            const fineResults = [];
            const clean = input.replace(/['-]/g, '');
            const alphabet = 'abcdefghijklmnopqrstuvwxyz√†√®√©√¨√≤√π';
            
            for (const letter of alphabet) {
                // Aggiunta iniziale
                if (checkInizio) {
                    const withStart = letter + clean;
                    if (wordSet.has(withStart)) {
                        inizioResults.push({
                            word: withStart,
                            added: letter.toUpperCase()
                        });
                    }
                }
                
                // Aggiunta finale
                if (checkFine) {
                    const withEnd = clean + letter;
                    if (wordSet.has(withEnd)) {
                        fineResults.push({
                            word: withEnd,
                            added: letter.toUpperCase()
                        });
                    }
                }
            }
            
            displayAggiunteResults(input, inizioResults, fineResults);
        }
        
        function displayAggiunteResults(input, inizioResults, fineResults) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            
            const total = inizioResults.length + fineResults.length;
            document.getElementById('resultsCount').textContent = `${total} aggiunt${total === 1 ? 'a' : 'e'} per "${input.toUpperCase()}"`;
            
            if (total === 0) {
                container.innerHTML = '<div class="no-results">Nessuna aggiunta trovata üòï</div>';
                card.classList.remove('hidden');
                return;
            }
            
            let html = '';
            
            if (inizioResults.length > 0) {
                html += `<div class="results-section"><h4>‚¨ÖÔ∏è Aggiunte iniziali (${inizioResults.length})</h4><div class="results-grid">`;
                for (const r of inizioResults) {
                    html += `<span class="result-word" onclick="searchWord('${escapeHtml(r.word)}')" style="cursor:pointer">
                        <strong>${r.added}+</strong> ‚Üí ${escapeHtml(r.word.toUpperCase())}
                    </span>`;
                }
                html += '</div></div>';
            }
            
            if (fineResults.length > 0) {
                html += `<div class="results-section"><h4>‚û°Ô∏è Aggiunte finali (${fineResults.length})</h4><div class="results-grid">`;
                for (const r of fineResults) {
                    html += `<span class="result-word" onclick="searchWord('${escapeHtml(r.word)}')" style="cursor:pointer">
                        <strong>+${r.added}</strong> ‚Üí ${escapeHtml(r.word.toUpperCase())}
                    </span>`;
                }
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        // Sciarade: scomponi una parola in due o pi√π parole di senso compiuto
        function findSciarade() {
            const input = document.getElementById('sciaradeInput').value.trim().toLowerCase();
            
            if (!input) {
                alert('Inserisci una parola');
                return;
            }
            
            const clean = input.replace(/['-]/g, '');
            if (clean.length < 4) {
                alert('Parola troppo corta (minimo 4 lettere)');
                return;
            }
            
            const minPartLen = parseInt(document.getElementById('selSciaradeMinPart').value);
            const maxParts = parseInt(document.getElementById('selSciaradeMaxParts').value);
            
            const results = findSciaradeSplit(clean, minPartLen, maxParts);
            displaySciaradeResults(input, results);
        }
        
        function findSciaradeSplit(word, minPartLen, maxParts) {
            const results = [];
            
            function search(remaining, parts) {
                if (remaining.length === 0) {
                    if (parts.length >= 2) {
                        results.push([...parts]);
                    }
                    return;
                }
                
                if (parts.length >= maxParts) return;
                if (results.length >= 100) return; // Limit results
                
                // Try all possible prefixes
                for (let i = minPartLen; i <= remaining.length; i++) {
                    const prefix = remaining.slice(0, i);
                    const rest = remaining.slice(i);
                    
                    // Check if prefix is a valid word
                    if (wordSet.has(prefix)) {
                        // If rest is empty, we found a complete split
                        if (rest.length === 0) {
                            parts.push(prefix);
                            if (parts.length >= 2) {
                                results.push([...parts]);
                            }
                            parts.pop();
                        } else if (rest.length >= minPartLen) {
                            // Continue searching
                            parts.push(prefix);
                            search(rest, parts);
                            parts.pop();
                        }
                    }
                }
            }
            
            search(word, []);
            return results;
        }
        
        function displaySciaradeResults(input, results) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            
            document.getElementById('resultsCount').textContent = `${results.length} sciarad${results.length === 1 ? 'a' : 'e'} per "${input.toUpperCase()}"`;
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">Nessuna sciarada trovata üòï</div>';
                card.classList.remove('hidden');
                return;
            }
            
            // Group by number of parts
            const byParts = {};
            for (const r of results) {
                const n = r.length;
                if (!byParts[n]) byParts[n] = [];
                byParts[n].push(r);
            }
            
            let html = '';
            const partCounts = Object.keys(byParts).map(Number).sort((a, b) => a - b);
            
            for (const n of partCounts) {
                html += `<div class="results-section"><h4>${n} parti (${byParts[n].length})</h4><div class="results-grid">`;
                for (const parts of byParts[n]) {
                    const display = parts.map(p => p.toUpperCase()).join(' + ');
                    html += `<span class="result-word result-multi">${escapeHtml(display)}</span>`;
                }
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        // Cerca sciarade nel dizionario (parole lunghe che si scompongono)
        function findSciaradeInverse() {
            const minPartLen = parseInt(document.getElementById('selSciaradeMinPart').value);
            const maxParts = parseInt(document.getElementById('selSciaradeMaxParts').value);
            
            const results = [];
            let checked = 0;
            
            // Check words of length >= 6
            for (const word of wordSet) {
                const clean = word.replace(/['-]/g, '');
                if (clean.length < 6) continue;
                if (clean.length > 15) continue; // Limit for performance
                
                checked++;
                if (checked > 5000) break; // Limit search
                
                const splits = findSciaradeSplit(clean, minPartLen, maxParts);
                if (splits.length > 0) {
                    results.push({
                        word: word,
                        splits: splits.slice(0, 3) // Max 3 splits per word
                    });
                }
                
                if (results.length >= 200) break;
            }
            
            displaySciaradeInverseResults(results);
        }
        
        function displaySciaradeInverseResults(results) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            
            document.getElementById('resultsCount').textContent = `${results.length} sciarade trovate nel dizionario`;
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">Nessuna sciarada trovata üòï</div>';
                card.classList.remove('hidden');
                return;
            }
            
            // Group by word length
            const byLen = {};
            for (const r of results) {
                const len = r.word.replace(/['-]/g, '').length;
                if (!byLen[len]) byLen[len] = [];
                byLen[len].push(r);
            }
            
            let html = '';
            const lengths = Object.keys(byLen).map(Number).sort((a, b) => a - b);
            
            for (const len of lengths) {
                html += `<div class="results-section"><h4>${len} lettere (${byLen[len].length})</h4><div class="results-grid">`;
                for (const r of byLen[len]) {
                    const mainWord = r.word.toUpperCase();
                    const firstSplit = r.splits[0].map(p => p.toUpperCase()).join(' + ');
                    html += `<span class="result-word" onclick="document.getElementById('sciaradeInput').value='${escapeHtml(r.word)}';findSciarade();" style="cursor:pointer">
                        <strong>${escapeHtml(mainWord)}</strong> = ${escapeHtml(firstSplit)}
                    </span>`;
                }
                html += '</div></div>';
            }
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
    </script>
</body>
</html>
