<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anagrammi e Ricerca Parole</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 0.9em; }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #3498db;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .tab:hover { background: #ebf5fb; }
        .tab.active { background: #3498db; color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .status-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .status { font-size: 0.9em; }
        .status.loaded { color: #27ae60; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button:active:not(:disabled) { transform: scale(0.98); }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover:not(:disabled) { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover:not(:disabled) { background: #1e8449; }
        .btn-secondary { background: #ecf0f1; color: #333; }
        .btn-secondary:hover:not(:disabled) { background: #bdc3c7; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover:not(:disabled) { background: #d68910; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover:not(:disabled) { background: #c0392b; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }
        
        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1.2em;
            margin-bottom: 15px;
        }
        
        input[type="text"]:focus { outline: none; border-color: #3498db; }
        
        .options { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .option { display: flex; align-items: center; gap: 6px; }
        .option label { font-size: 0.9em; color: #555; }
        
        select { padding: 6px 10px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 0.9em; }
        
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .results-header h3 { margin: 0; color: #2c3e50; }
        .results-count { color: #7f8c8d; font-size: 0.9em; }
        .results-container { max-height: 500px; overflow-y: auto; }
        .results-section { margin-bottom: 20px; }
        
        .results-section h4 {
            color: #3498db;
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.95em;
        }
        
        .results-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .result-word {
            background: #ecf0f1;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .result-word:hover { background: #3498db; color: white; }
        .result-multi { background: #e8f6f3; border-left: 3px solid #1abc9c; }
        .result-multi:hover { background: #1abc9c; }
        .result-partial { background: #fdf2e9; border-left: 3px solid #e67e22; }
        .result-partial:hover { background: #e67e22; }
        .result-custom { background: #e8f8f5; border: 1px dashed #1abc9c; }
        .result-custom:hover { background: #1abc9c; }
        
        .no-results { text-align: center; color: #7f8c8d; padding: 30px; }
        .no-results-small { color: #95a5a6; font-style: italic; padding: 8px 0; }
        .loading-box { text-align: center; padding: 20px; }
        
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #ecf0f1;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .progress-bar { width: 100%; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: #3498db; transition: width 0.3s; }
        
        .info-message { padding: 12px 15px; border-radius: 8px; margin-top: 15px; font-size: 0.9em; }
        .info-message.error { background: #fdedec; border-left: 4px solid #e74c3c; }
        .info-message.success { background: #e8f6f3; border-left: 4px solid #27ae60; }
        
        .hidden { display: none !important; }
        
        .dict-options { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ecf0f1; }
        .dict-options summary { cursor: pointer; color: #7f8c8d; font-size: 0.9em; }
        .dict-options-content { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
        .custom-words-count { font-size: 0.85em; color: #7f8c8d; margin-top: 10px; }
        
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 8px 0;
            z-index: 1000;
            min-width: 150px;
        }
        
        .context-menu-item { padding: 10px 16px; cursor: pointer; font-size: 0.9em; }
        .context-menu-item:hover { background: #f5f5f5; }
        .context-menu-item.danger { color: #e74c3c; }
        
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal { background: white; border-radius: 12px; padding: 25px; max-width: 400px; width: 100%; }
        .modal h3 { margin: 0 0 20px 0; color: #2c3e50; }
        .modal input { margin-bottom: 10px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
        
        .length-group { margin-bottom: 8px; }
        .length-label { font-size: 0.8em; color: #7f8c8d; margin-bottom: 4px; }
        .hint { font-size: 0.8em; color: #95a5a6; text-align: center; margin-top: 10px; }
        
        .hint-box {
            background: #fef9e7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.85em;
        }
        
        .hint-box code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .dict-selector { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        
        .dict-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dict-btn:hover { border-color: #3498db; }
        .dict-btn.active { border-color: #3498db; background: #ebf5fb; }
        .dict-btn-title { font-weight: bold; color: #2c3e50; }
        .dict-btn-info { font-size: 0.8em; color: #7f8c8d; margin-top: 4px; }
        
        .credits { font-size: 0.75em; color: #95a5a6; text-align: center; margin-top: 5px; }
        .credits a { color: #7f8c8d; }
        
        @media (max-width: 600px) {
            body { padding: 10px; }
            .card { padding: 15px; }
            .options { flex-direction: column; gap: 10px; }
            .status-bar { flex-direction: column; align-items: stretch; }
            .btn-group { flex-direction: column; }
            button { width: 100%; }
            .modal-buttons { flex-direction: column; }
            .tab { padding: 10px 8px; font-size: 0.85em; }
        }
    </style>
</head>
<body>
    <h1>üî§ Enigmistica</h1>
    <p class="subtitle">Anagrammi e ricerca parole italiane</p>
    
    <div class="card">
        <div class="status-bar">
            <div class="status" id="dictStatus">
                <span id="statusText">‚è≥ Seleziona un vocabolario...</span>
            </div>
            <div class="btn-group">
                <button class="btn-success btn-small" onclick="showAddWordModal()" id="btnAddWord" disabled>‚ûï Aggiungi</button>
            </div>
        </div>
        
        <div class="dict-selector" id="dictSelector">
            <button class="dict-btn" onclick="loadDict('ridotto')">
                <div class="dict-btn-title">üìò Ridotto</div>
                <div class="dict-btn-info">~31k parole ‚Ä¢ Veloce</div>
            </button>
            <button class="dict-btn" onclick="loadDict('completo')">
                <div class="dict-btn-title">üìö Completo</div>
                <div class="dict-btn-info">~283k parole ‚Ä¢ Esaustivo</div>
            </button>
        </div>
        
        <div id="loadingIndicator" class="loading-box hidden">
            <div class="spinner"></div>
            <div id="loadingText">Caricamento...</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
        </div>
        
        <div id="infoMessage" class="info-message hidden"></div>
        
        <details class="dict-options hidden" id="dictOptions">
            <summary>Opzioni dizionario</summary>
            <div class="dict-options-content">
                <button class="btn-secondary btn-small" onclick="exportDictionary()">üì• Esporta</button>
                <button class="btn-warning btn-small" onclick="suggestWord()">‚úâÔ∏è Suggerisci</button>
                <button class="btn-secondary btn-small" onclick="restoreRemoved()">‚ôªÔ∏è Ripristina</button>
                <button class="btn-danger btn-small" onclick="switchDict()">üîÑ Cambia</button>
            </div>
            <div class="custom-words-count" id="customWordsCount"></div>
        </details>
        
        <p class="credits">Vocabolario: <a href="http://www.enignet.it" target="_blank">Enilab/BEI</a></p>
    </div>
    
    <div class="card" id="searchCard">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('anagrammi')">üîÑ Anagrammi</button>
            <button class="tab" onclick="switchTab('ricerca')">üîç Cerca parole</button>
        </div>
        
        <!-- Tab Anagrammi -->
        <div class="tab-content active" id="tab-anagrammi">
            <input type="text" id="inputWord" placeholder="Scrivi una parola..." onkeyup="handleKeyUp(event, 'anagrammi')" disabled>
            
            <div class="options">
                <div class="option"><input type="checkbox" id="chkMulti" checked><label for="chkMulti">Multi-parola</label></div>
                <div class="option"><input type="checkbox" id="chkPartial" checked><label for="chkPartial">Parole incluse</label></div>
                <div class="option"><label for="selMaxWords">Max:</label><select id="selMaxWords"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option></select></div>
                <div class="option"><label for="selMinLen">Min:</label><select id="selMinLen"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select></div>
            </div>
            
            <button class="btn-primary" onclick="findAnagrams()" id="btnSearch" disabled style="width: 100%;">üîç Cerca anagrammi</button>
            <p class="hint">üí° Tieni premuto su una parola per rimuoverla</p>
        </div>
        
        <!-- Tab Ricerca -->
        <div class="tab-content" id="tab-ricerca">
            <div class="hint-box">
                <strong>Pattern:</strong> 
                <code>.</code> o <code>?</code> = una lettera &nbsp;
                <code>+</code> = vocale &nbsp;
                <code>-</code> = consonante &nbsp;
                <code>*</code> = pi√π lettere
            </div>
            
            <input type="text" id="inputPattern" placeholder="Es: cas+, *zione, p-+ma..." onkeyup="handleKeyUp(event, 'ricerca')" disabled>
            
            <div class="options">
                <div class="option">
                    <label for="selMinLenSearch">Lunghezza min:</label>
                    <select id="selMinLenSearch">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <div class="option">
                    <label for="selMaxLenSearch">max:</label>
                    <select id="selMaxLenSearch">
                        <option value="10">10</option>
                        <option value="15" selected>15</option>
                        <option value="20">20</option>
                        <option value="99">‚àû</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-primary" onclick="searchPattern()" id="btnPattern" disabled style="width: 100%;">üîç Cerca parole</button>
            <p class="hint">Es: <code>cas+</code> ‚Üí casa, case, caso | <code>*mente</code> ‚Üí parole che finiscono in "mente"</p>
        </div>
    </div>
    
    <div class="card hidden" id="resultsCard">
        <div class="results-header"><h3>Risultati</h3><span class="results-count" id="resultsCount"></span></div>
        <div class="results-container" id="resultsContainer"></div>
    </div>
    
    <div class="context-menu hidden" id="contextMenu">
        <div class="context-menu-item" onclick="searchSelectedWord()">üîÑ Anagrammi</div>
        <div class="context-menu-item" onclick="patternSelectedWord()">üîç Cerca pattern</div>
        <div class="context-menu-item danger" onclick="removeSelectedWord()">üóëÔ∏è Rimuovi</div>
    </div>
    
    <div class="modal-overlay hidden" id="addWordModal" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <h3>‚ûï Aggiungi parola</h3>
            <input type="text" id="newWordInput" placeholder="Nuova parola..." onkeyup="handleAddWordKeyUp(event)">
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0;">Salvata nel browser.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeAddWordModal()">Annulla</button>
                <button class="btn-success" onclick="addWord()">Aggiungi</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="suggestModal" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <h3>‚úâÔ∏è Suggerisci parola</h3>
            <input type="text" id="suggestWordInput" placeholder="Parola da suggerire...">
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0;">Si aprir√† il client email.</p>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeSuggestModal()">Annulla</button>
                <button class="btn-warning" onclick="sendSuggestion()">Invia</button>
            </div>
        </div>
    </div>

    <script>
        const DICT_BASE = 'https://infingardo.github.io/Enigmistica/';
        const DICT_FILES = { 
            ridotto: DICT_BASE + 'dizionario_ridotto.txt', 
            completo: DICT_BASE + 'dizionario_completo.txt' 
        };
        const CONTACT_EMAIL = 'critto@gmail.com';
        const CONTACT_NAME = 'kc8';
        const DB_NAME = 'AnagrammiBEI';
        const DB_VERSION = 1;
        const STORE_NAME = 'data';
        
        const VOWELS = 'aeiou√†√®√©√¨√≤√π';
        const CONSONANTS = 'bcdfghjklmnpqrstvwxyz';
        
        let db = null, dictIndex = null, wordSet = null, wordList = null, customWords = null, removedWords = null;
        let dictSize = 0, currentDict = null, selectedWord = null, longPressTimer = null;
        let currentTab = 'anagrammi';
        
        document.addEventListener('DOMContentLoaded', init);
        document.addEventListener('click', hideContextMenu);
        
        async function init() {
            try {
                db = await openDB();
                const saved = await dbGet('currentDict');
                if (saved) await loadDict(saved, true);
            } catch (err) { console.error('Init:', err); }
        }
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${tab === 'anagrammi' ? 1 : 2})`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('resultsCard').classList.add('hidden');
        }
        
        function openDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
                req.onupgradeneeded = (e) => {
                    if (!e.target.result.objectStoreNames.contains(STORE_NAME))
                        e.target.result.createObjectStore(STORE_NAME);
                };
            });
        }
        
        function dbGet(key) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const req = tx.objectStore(STORE_NAME).get(key);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
            });
        }
        
        function dbPut(key, value) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const req = tx.objectStore(STORE_NAME).put(value, key);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve();
            });
        }
        
        async function loadDict(type, fromCache = false) {
            currentDict = type;
            document.querySelectorAll('.dict-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(type));
            });
            
            customWords = new Set(await dbGet(`custom_${type}`) || []);
            removedWords = new Set(await dbGet(`removed_${type}`) || []);
            
            const cached = await dbGet(`dict_${type}`);
            if (cached && fromCache) {
                dictIndex = new Map(cached.index);
                wordSet = new Set(cached.words);
                wordList = cached.words;
                dictSize = cached.size;
                finishLoad();
            } else {
                await downloadDict(type);
            }
        }
        
        async function downloadDict(type) {
            const loader = document.getElementById('loadingIndicator');
            loader.classList.remove('hidden');
            updateLoadingText('Download vocabolario...');
            updateProgress(0);
            
            try {
                const res = await fetch(DICT_FILES[type]);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const text = await res.text();
                updateLoadingText('Elaborazione...');
                updateProgress(50);
                
                await processWords(text);
                
                for (const w of customWords) addWordToIndex(w);
                for (const w of removedWords) removeWordFromIndex(w);
                
                wordList = Array.from(wordSet);
                
                await dbPut(`dict_${type}`, { index: Array.from(dictIndex.entries()), words: wordList, size: dictSize });
                await dbPut('currentDict', type);
                
                loader.classList.add('hidden');
                finishLoad();
            } catch (err) {
                loader.classList.add('hidden');
                showError(`Errore: ${err.message}. Verifica che i file dizionario siano nella stessa cartella.`);
            }
        }
        
        async function processWords(text) {
            const lines = text.split(/[\r\n]+/);
            dictIndex = new Map();
            wordSet = new Set();
            dictSize = 0;
            
            for (let i = 0; i < lines.length; i += 10000) {
                const batch = lines.slice(i, Math.min(i + 10000, lines.length));
                for (const line of batch) {
                    const word = line.trim().toLowerCase();
                    if (isValidWord(word)) addWordToIndex(word);
                }
                updateProgress(50 + (Math.min(i + 10000, lines.length) / lines.length) * 50);
                await new Promise(r => setTimeout(r, 0));
            }
        }
        
        function finishLoad() {
            document.getElementById('dictSelector').classList.add('hidden');
            document.getElementById('dictOptions').classList.remove('hidden');
            document.getElementById('inputWord').disabled = false;
            document.getElementById('inputPattern').disabled = false;
            document.getElementById('btnSearch').disabled = false;
            document.getElementById('btnPattern').disabled = false;
            document.getElementById('btnAddWord').disabled = false;
            document.getElementById('inputWord').focus();
            
            const label = currentDict === 'ridotto' ? 'üìò Ridotto' : 'üìö Completo';
            updateStatus('loaded', `‚úÖ ${label} (${formatNumber(dictSize)} parole)`);
            updateCustomWordsCount();
        }
        
        function switchDict() {
            document.getElementById('dictSelector').classList.remove('hidden');
            document.getElementById('dictOptions').classList.add('hidden');
            document.getElementById('resultsCard').classList.add('hidden');
            document.getElementById('inputWord').disabled = true;
            document.getElementById('inputPattern').disabled = true;
            document.getElementById('btnSearch').disabled = true;
            document.getElementById('btnPattern').disabled = true;
            updateStatus('', '‚è≥ Seleziona un vocabolario...');
        }
        
        function isValidWord(word) { return word && word.length >= 2 && /^[a-z√†√®√©√¨√≤√π√¢√™√Æ√¥√ª√§√´√Ø√∂√º√ß'-]+$/i.test(word); }
        
        function addWordToIndex(word) {
            const clean = word.replace(/['-]/g, '');
            if (clean.length < 2) return false;
            const sig = getSignature(clean);
            if (!dictIndex.has(sig)) dictIndex.set(sig, []);
            if (!wordSet.has(word)) {
                dictIndex.get(sig).push(word);
                wordSet.add(word);
                dictSize++;
                return true;
            }
            return false;
        }
        
        function removeWordFromIndex(word) {
            if (!wordSet.has(word)) return false;
            const sig = getSignature(word.replace(/['-]/g, ''));
            wordSet.delete(word);
            dictSize--;
            if (dictIndex.has(sig)) {
                const words = dictIndex.get(sig).filter(w => w !== word);
                if (words.length === 0) dictIndex.delete(sig);
                else dictIndex.set(sig, words);
            }
            return true;
        }
        
        async function saveCustomData() {
            wordList = Array.from(wordSet);
            await dbPut(`custom_${currentDict}`, Array.from(customWords));
            await dbPut(`removed_${currentDict}`, Array.from(removedWords));
            await dbPut(`dict_${currentDict}`, { index: Array.from(dictIndex.entries()), words: wordList, size: dictSize });
        }
        
        // Pattern search
        function patternToRegex(pattern) {
            let regex = '^';
            for (const char of pattern.toLowerCase()) {
                if (char === '.' || char === '?') {
                    regex += '[a-z√†√®√©√¨√≤√π√¢√™√Æ√¥√ª√§√´√Ø√∂√º√ß]';
                } else if (char === '+') {
                    regex += `[${VOWELS}]`;
                } else if (char === '-') {
                    regex += `[${CONSONANTS}]`;
                } else if (char === '*') {
                    regex += '[a-z√†√®√©√¨√≤√π√¢√™√Æ√¥√ª√§√´√Ø√∂√º√ß]*';
                } else if (/[a-z√†√®√©√¨√≤√π√¢√™√Æ√¥√ª√§√´√Ø√∂√º√ß]/.test(char)) {
                    regex += char;
                }
            }
            regex += '$';
            return new RegExp(regex, 'i');
        }
        
        function searchPattern() {
            const pattern = document.getElementById('inputPattern').value.trim();
            if (!pattern) return;
            
            const minLen = parseInt(document.getElementById('selMinLenSearch').value);
            const maxLen = parseInt(document.getElementById('selMaxLenSearch').value);
            
            let regex;
            try {
                regex = patternToRegex(pattern);
            } catch (e) {
                alert('Pattern non valido');
                return;
            }
            
            const results = [];
            for (const word of wordList) {
                if (word.length < minLen || word.length > maxLen) continue;
                if (regex.test(word)) {
                    results.push(word);
                    if (results.length >= 1000) break;
                }
            }
            
            results.sort((a, b) => a.length - b.length || a.localeCompare(b));
            displayPatternResults(pattern, results);
        }
        
        function displayPatternResults(pattern, results) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            
            document.getElementById('resultsCount').textContent = `${results.length}${results.length >= 1000 ? '+' : ''} risultat${results.length === 1 ? 'o' : 'i'} per "${pattern}"`;
            
            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">Nessuna parola trovata üòï</div>';
                card.classList.remove('hidden');
                return;
            }
            
            // Raggruppa per lunghezza
            const byLen = {};
            for (const w of results) {
                const len = w.length;
                if (!byLen[len]) byLen[len] = [];
                byLen[len].push(w);
            }
            
            const lengths = Object.keys(byLen).map(Number).sort((a, b) => a - b);
            
            let html = `<div class="results-section">
                ${lengths.map(len => `
                    <div class="length-group">
                        <div class="length-label">${len} lettere (${byLen[len].length})</div>
                        <div class="results-grid">${byLen[len].map(w => wordSpan(w)).join('')}</div>
                    </div>
                `).join('')}
            </div>`;
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        // Word management
        function showAddWordModal() {
            document.getElementById('addWordModal').classList.remove('hidden');
            document.getElementById('newWordInput').value = '';
            document.getElementById('newWordInput').focus();
        }
        
        function closeAddWordModal() { document.getElementById('addWordModal').classList.add('hidden'); }
        function handleAddWordKeyUp(e) { if (e.key === 'Enter') addWord(); if (e.key === 'Escape') closeAddWordModal(); }
        
        async function addWord() {
            const word = document.getElementById('newWordInput').value.trim().toLowerCase();
            if (!word) { alert('Inserisci una parola'); return; }
            if (!isValidWord(word)) { alert('Parola non valida'); return; }
            if (wordSet.has(word)) { alert('Gi√† presente'); closeAddWordModal(); return; }
            
            removedWords.delete(word);
            addWordToIndex(word);
            customWords.add(word);
            await saveCustomData();
            
            closeAddWordModal();
            updateStatus('loaded', `‚úÖ ${currentDict === 'ridotto' ? 'üìò Ridotto' : 'üìö Completo'} (${formatNumber(dictSize)} parole)`);
            updateCustomWordsCount();
            showSuccess(`"${word}" aggiunta!`);
        }
        
        async function removeWord(word) {
            if (!wordSet.has(word)) return;
            removeWordFromIndex(word);
            removedWords.add(word);
            customWords.delete(word);
            await saveCustomData();
            
            updateStatus('loaded', `‚úÖ ${currentDict === 'ridotto' ? 'üìò Ridotto' : 'üìö Completo'} (${formatNumber(dictSize)} parole)`);
            updateCustomWordsCount();
            showSuccess(`"${word}" rimossa`);
            if (!document.getElementById('resultsCard').classList.contains('hidden')) {
                if (currentTab === 'anagrammi') findAnagrams();
                else searchPattern();
            }
        }
        
        async function restoreRemoved() {
            if (removedWords.size === 0) { alert('Niente da ripristinare'); return; }
            if (!confirm(`Ripristinare ${removedWords.size} parole?`)) return;
            for (const w of removedWords) addWordToIndex(w);
            removedWords.clear();
            await saveCustomData();
            updateStatus('loaded', `‚úÖ ${currentDict === 'ridotto' ? 'üìò Ridotto' : 'üìö Completo'} (${formatNumber(dictSize)} parole)`);
            updateCustomWordsCount();
            showSuccess('Ripristinate!');
        }
        
        function updateCustomWordsCount() {
            const el = document.getElementById('customWordsCount');
            const parts = [];
            if (customWords.size > 0) parts.push(`+${customWords.size} aggiunte`);
            if (removedWords.size > 0) parts.push(`-${removedWords.size} rimosse`);
            el.textContent = parts.length > 0 ? `üìù ${parts.join(', ')}` : '';
        }
        
        // Context menu
        function showContextMenu(e, word) {
            e.preventDefault();
            selectedWord = word;
            const menu = document.getElementById('contextMenu');
            menu.classList.remove('hidden');
            menu.style.left = Math.min(e.clientX || 0, window.innerWidth - 160) + 'px';
            menu.style.top = Math.min(e.clientY || 0, window.innerHeight - 100) + 'px';
        }
        
        function hideContextMenu() { document.getElementById('contextMenu').classList.add('hidden'); selectedWord = null; }
        
        function searchSelectedWord() { 
            if (selectedWord) { 
                switchTab('anagrammi');
                document.getElementById('inputWord').value = selectedWord; 
                findAnagrams(); 
            } 
            hideContextMenu(); 
        }
        
        function patternSelectedWord() {
            if (selectedWord) {
                switchTab('ricerca');
                document.getElementById('inputPattern').value = selectedWord;
            }
            hideContextMenu();
        }
        
        function removeSelectedWord() { if (selectedWord) removeWord(selectedWord); hideContextMenu(); }
        function handleWordTouchStart(e, word) { longPressTimer = setTimeout(() => showContextMenu(e, word), 500); }
        function handleWordTouchEnd() { clearTimeout(longPressTimer); }
        
        // Export & Suggest
        function exportDictionary() {
            const words = Array.from(wordSet).sort();
            const blob = new Blob([words.join('\n')], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `dizionario_${currentDict}.txt`;
            a.click();
            showSuccess(`Esportate ${formatNumber(words.length)} parole`);
        }
        
        function suggestWord() {
            document.getElementById('suggestModal').classList.remove('hidden');
            document.getElementById('suggestWordInput').value = '';
            document.getElementById('suggestWordInput').focus();
        }
        
        function closeSuggestModal() { document.getElementById('suggestModal').classList.add('hidden'); }
        
        function sendSuggestion() {
            const word = document.getElementById('suggestWordInput').value.trim();
            if (!word) { alert('Inserisci una parola'); return; }
            window.location.href = `mailto:${CONTACT_EMAIL}?subject=${encodeURIComponent(`Suggerimento: ${word}`)}&body=${encodeURIComponent(`Caro ${CONTACT_NAME},\n\nti suggerisco di aggiungere:\n\n${word}\n\nGrazie!`)}`;
            closeSuggestModal();
        }
        
        function closeModalOnOverlay(e) { if (e.target.classList.contains('modal-overlay')) e.target.classList.add('hidden'); }
        
        // Anagrams
        function getSignature(word) { return word.toLowerCase().replace(/['-]/g, '').split('').sort().join(''); }
        
        function findAnagrams() {
            const input = document.getElementById('inputWord').value.trim().toLowerCase();
            if (!input) return;
            
            const clean = input.replace(/[^a-z√†√®√©√¨√≤√π√¢√™√Æ√¥√ª√§√´√Ø√∂√º√ß]/gi, '');
            if (clean.length < 2) { alert('Almeno 2 lettere'); return; }
            
            const minLen = parseInt(document.getElementById('selMinLen').value);
            const multiWord = document.getElementById('chkMulti').checked;
            const showPartial = document.getElementById('chkPartial').checked;
            const maxWords = parseInt(document.getElementById('selMaxWords').value);
            
            const single = (dictIndex.get(getSignature(clean)) || []).filter(w => w.toLowerCase() !== clean);
            let multi = multiWord && clean.length <= 15 ? findMultiWordAnagrams(clean, maxWords, minLen) : [];
            let partial = showPartial ? findPartialAnagrams(clean, minLen) : [];
            
            displayAnagramResults(clean, single, multi, partial);
        }
        
        function findPartialAnagrams(input, minLen) {
            const results = [];
            const lc = {};
            for (const l of input) lc[l] = (lc[l] || 0) + 1;
            
            for (const word of wordSet) {
                const clean = word.replace(/['-]/g, '');
                if (clean.length >= input.length || clean.length < minLen) continue;
                
                const wc = {};
                let valid = true;
                for (const l of clean) { wc[l] = (wc[l] || 0) + 1; if (wc[l] > (lc[l] || 0)) { valid = false; break; } }
                if (valid) results.push(word);
            }
            
            results.sort((a, b) => b.length - a.length || a.localeCompare(b));
            return results;
        }
        
        function findMultiWordAnagrams(input, maxWords, minLen) {
            const results = [], letters = input.split('').sort(), seen = new Set();
            const candidates = findCandidates(letters, minLen);
            
            function search(rem, cur, depth) {
                if (rem.length === 0 && cur.length >= 2) {
                    const key = [...cur].sort().join(' ');
                    if (!seen.has(key)) { seen.add(key); results.push([...cur]); }
                    return;
                }
                if (depth >= maxWords || results.length >= 500) return;
                
                for (const word of candidates) {
                    const wl = word.replace(/['-]/g, '').split('').sort();
                    if (wl.length > rem.length || wl.length < minLen) continue;
                    const newRem = trySubtract(rem, wl);
                    if (newRem) { cur.push(word); search(newRem, cur, depth + 1); cur.pop(); }
                }
            }
            
            search(letters, [], 0);
            return results;
        }
        
        function findCandidates(letters, minLen) {
            const candidates = [], lc = {};
            for (const l of letters) lc[l] = (lc[l] || 0) + 1;
            
            for (const word of wordSet) {
                if (word.length < minLen) continue;
                const clean = word.replace(/['-]/g, '');
                if (clean.length > letters.length) continue;
                
                const wc = {};
                let valid = true;
                for (const l of clean) { wc[l] = (wc[l] || 0) + 1; if (wc[l] > (lc[l] || 0)) { valid = false; break; } }
                if (valid) candidates.push(word);
            }
            
            candidates.sort((a, b) => b.length - a.length);
            return candidates;
        }
        
        function trySubtract(arr, toRemove) {
            const result = [...arr];
            for (const item of toRemove) { const idx = result.indexOf(item); if (idx === -1) return null; result.splice(idx, 1); }
            return result;
        }
        
        function displayAnagramResults(input, single, multi, partial) {
            const container = document.getElementById('resultsContainer');
            const card = document.getElementById('resultsCard');
            const total = single.length + multi.length + partial.length;
            
            document.getElementById('resultsCount').textContent = `${total} risultat${total === 1 ? 'o' : 'i'} per "${input}"`;
            
            let html = '';
            
            // Anagrammi perfetti - sempre visibile
            html += `<div class="results-section"><h4>üéØ Anagrammi perfetti (${single.length})</h4>`;
            if (single.length > 0) {
                html += `<div class="results-grid">${single.map(w => wordSpan(w)).join('')}</div>`;
            } else {
                html += `<div class="no-results-small">Nessuno</div>`;
            }
            html += `</div>`;
            
            // Multi-parola - sempre visibile se opzione attiva
            if (document.getElementById('chkMulti').checked) {
                html += `<div class="results-section"><h4>üîó Multi-parola (${multi.length})</h4>`;
                if (multi.length > 0) {
                    html += `<div class="results-grid">${multi.map(arr => `<span class="result-word result-multi">${arr.map(escapeHtml).join(' + ')}</span>`).join('')}</div>`;
                } else {
                    html += `<div class="no-results-small">Nessuno</div>`;
                }
                html += `</div>`;
            }
            
            // Parole incluse - sempre visibile se opzione attiva
            if (document.getElementById('chkPartial').checked) {
                html += `<div class="results-section"><h4>üì¶ Parole incluse (${partial.length})</h4>`;
                if (partial.length > 0) {
                    const byLen = {};
                    for (const w of partial) { const len = w.replace(/['-]/g, '').length; if (!byLen[len]) byLen[len] = []; byLen[len].push(w); }
                    const lengths = Object.keys(byLen).map(Number).sort((a, b) => b - a);
                    html += lengths.map(len => `<div class="length-group"><div class="length-label">${len} lettere (${byLen[len].length})</div><div class="results-grid">${byLen[len].map(w => wordSpan(w, 'result-partial')).join('')}</div></div>`).join('');
                } else {
                    html += `<div class="no-results-small">Nessuna</div>`;
                }
                html += `</div>`;
            }
            
            container.innerHTML = html;
            card.classList.remove('hidden');
        }
        
        function wordSpan(word, extra = '') {
            const isCustom = customWords.has(word);
            const cls = `result-word ${extra} ${isCustom ? 'result-custom' : ''}`.trim();
            const esc = escapeHtml(word);
            return `<span class="${cls}" onclick="searchWord('${esc}')" oncontextmenu="showContextMenu(event, '${esc}')" ontouchstart="handleWordTouchStart(event, '${esc}')" ontouchend="handleWordTouchEnd()" ontouchmove="handleWordTouchEnd()">${esc}</span>`;
        }
        
        function searchWord(word) { 
            switchTab('anagrammi');
            document.getElementById('inputWord').value = word; 
            findAnagrams(); 
        }
        
        function escapeHtml(str) { return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
        
        function updateStatus(type, text) { document.getElementById('dictStatus').className = 'status ' + type; document.getElementById('statusText').textContent = text; }
        function updateLoadingText(text) { document.getElementById('loadingText').textContent = text; }
        function updateProgress(percent) { document.getElementById('progressFill').style.width = percent + '%'; }
        
        function showError(msg) { const el = document.getElementById('infoMessage'); el.textContent = msg; el.className = 'info-message error'; el.classList.remove('hidden'); }
        function showSuccess(msg) { const el = document.getElementById('infoMessage'); el.textContent = msg; el.className = 'info-message success'; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 2500); }
        function handleKeyUp(e, tab) { if (e.key === 'Enter') { if (tab === 'anagrammi') findAnagrams(); else searchPattern(); } }
        function formatNumber(n) { return n.toLocaleString('it-IT'); }
    </script>
</body>
</html>
